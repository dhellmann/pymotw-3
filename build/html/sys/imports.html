<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Modules and Imports &mdash; PyMOTW 3</title>

    <link rel="stylesheet" href="../_static/pure-min.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/font-awesome/css/font-awesome.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pymotw.css" type="text/css">

    <link rel="shortcut icon" type="image/png" href="../_static/favicon.png">

    <link rel="alternate" type="application/atom+xml"
          title="Doug Hellmann"
          href="http://feeds.doughellmann.com/DougHellmann" />
    <link rel="alternate" type="application/atom+xml"
          title="PyMOTW Updates"
          href="http://feeds.doughellmann.com/PyMOTW" />

    <meta name="verify-v1" content="5saTcOa2HLac4V85yUg3SARfun1PqT5Upu7IR/6fpv4="/>

  </head>
  <body>

    <div class="pure-menu pure-menu-open pure-menu-horizontal" id="site-menu">
      <a class="pure-menu-heading" href="../index.html"><img src="../_static/logo.png"> PyMOTW-3</a>

      <ul id="top-menu">
        <li class="pure-menu-selected"><a href="../py-modindex.html"><i class="fa fa-list fa-lg"></i> Module Index</a></li>
        <li class="pure-menu-selected"><a href="../genindex.html"><i class="fa fa-italic fa-lg"></i> Index</a></li>
        <li class="pure-menu-selected"><a class="sociallink" href="http://www.twitter.com/pymotw"
       title="Twitter">
      <i class="fa fa-twitter fa-lg"></i></a></a>
        <li class="pure-menu-selected"><a class="sociallink" href="http://feeds.doughellmann.com/PyMOTW"
       title="Subscribe via RSS">
      <i class="fa fa-rss-square fa-lg"></i></a></li>
      </ul>

    </div>

    <div class="pure-menu pure-menu-open pure-menu-vertical" id="breadcrumbs-menu">
      
      <ul id="breadcrumbs">
        <li class="pure-menu-selected"><a href="../runtime_services.html"><i class="fa fa-arrow-circle-up"></i> Runtime Features</a></li>
        <li class="pure-menu-selected"><a href="index.html"><i class="fa fa-arrow-circle-up"></i> sys — System-specific Configuration</a></li>
      </ul>
    </div>

    <div class="pure-g-r" id="content-container">

      <div class="pure-u-3-4">
        <div class="content">
          
  <div class="section" id="modules-and-imports">
<span id="sys-imports"></span><h1>Modules and Imports<a class="headerlink" href="#modules-and-imports" title="Permalink to this headline">¶</a></h1>
<p>Most Python programs end up as a combination of several modules with a
main application importing them. Whether using the features of the
standard library or organizing custom code in separate files to make
it easier to maintain, understanding and managing the dependencies for
a program is an important aspect of development. <code class="docutils literal notranslate"><span class="pre">sys</span></code> includes
information about the modules available to an application, either as
built-ins or after being imported.  It also defines hooks for
overriding the standard import behavior for special cases.</p>
<div class="section" id="imported-modules">
<span id="sys-modules"></span><h2>Imported Modules<a class="headerlink" href="#imported-modules" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">sys.modules</span></code> is a dictionary mapping the names of imported
modules to the module object holding the code.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">sys_modules.py</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">textwrap</span>

<span class="n">names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">name_text</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">name_text</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">64</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>The contents of <code class="docutils literal notranslate"><span class="pre">sys.modules</span></code> change as new modules are imported.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 sys_modules.py

__main__, _abc, _bootlocale, _codecs, _collections,
_collections_abc, _frozen_importlib, _frozen_importlib_external,
_functools, _heapq, _imp, _io, _locale, _operator, _signal,
_sre, _stat, _thread, _warnings, _weakref, abc, builtins,
codecs, collections, contextlib, copyreg, encodings,
encodings.aliases, encodings.latin_1, encodings.utf_8, enum,
functools, genericpath, heapq, importlib, importlib._bootstrap,
importlib._bootstrap_external, importlib.abc,
importlib.machinery, importlib.util, io, itertools, keyword,
marshal, operator, os, os.path, posix, posixpath, re, reprlib,
site, sphinxcontrib, sre_compile, sre_constants, sre_parse,
stat, sys, textwrap, types, warnings, zipimport
</pre></div>
</div>
</div>
<div class="section" id="built-in-modules">
<h2>Built-in Modules<a class="headerlink" href="#built-in-modules" title="Permalink to this headline">¶</a></h2>
<p>The Python interpreter can be compiled with some C modules built right
in, so they do not need to be distributed as separate shared
libraries. These modules do not appear in the list of imported modules
managed in <code class="docutils literal notranslate"><span class="pre">sys.modules</span></code> because they were not technically
imported. The only way to find the available built-in modules is
through <code class="docutils literal notranslate"><span class="pre">sys.builtin_module_names</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">sys_builtins.py</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">textwrap</span>

<span class="n">name_text</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">builtin_module_names</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">name_text</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">64</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>The output of this script will vary, especially if run with a
custom-built version of the interpreter.  This output was created
using a copy of the interpreter installed from the standard python.org
installer for OS X.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 sys_builtins.py

_abc, _ast, _codecs, _collections, _functools, _imp, _io,
_locale, _operator, _signal, _sre, _stat, _string, _symtable,
_thread, _tracemalloc, _warnings, _weakref, atexit, builtins,
errno, faulthandler, gc, itertools, marshal, posix, pwd, sys,
time, xxsubtype, zipimport
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<ul class="last simple">
<li><a class="reference external" href="https://hg.python.org/cpython/file/tip/README">Build Instructions</a> –
Instructions for building Python, from the README distributed with the source.</li>
</ul>
</div>
</div>
<div class="section" id="import-path">
<span id="sys-path"></span><h2>Import Path<a class="headerlink" href="#import-path" title="Permalink to this headline">¶</a></h2>
<p>The search path for modules is managed as a Python list saved in
<code class="docutils literal notranslate"><span class="pre">sys.path</span></code>. The default contents of the path include the directory
of the script used to start the application and the current working
directory.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">sys_path_show.py</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>

<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The first directory in the search path is the home for the sample
script itself. That is followed by a series of platform-specific paths
where compiled extension modules (written in C) might be installed,
and then the global <code class="docutils literal notranslate"><span class="pre">site-packages</span></code> directory is listed last.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 sys_path_show.py

/Users/dhellmann/Documents/PyMOTW/pymotw-3/source/sys
.../python35.zip
.../lib/python3.5
.../lib/python3.5/plat-darwin
.../python3.5/lib-dynload
.../lib/python3.5/site-packages
</pre></div>
</div>
<p>The import search-path list can be modified before starting the
interpreter by setting the shell variable <code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code> to a
colon-separated list of directories.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ PYTHONPATH=/my/private/site-packages:/my/shared/site-packages \
&gt; python3 sys_path_show.py

/Users/dhellmann/Documents/PyMOTW/pymotw-3/source/sys
/my/private/site-packages
/my/shared/site-packages
.../python35.zip
.../lib/python3.5
.../lib/python3.5/plat-darwin
.../python3.5/lib-dynload
.../lib/python3.5/site-packages
</pre></div>
</div>
<p>A program can also modify its path by adding elements to
<code class="docutils literal notranslate"><span class="pre">sys.path</span></code> directly.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">sys_path_modify.py</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;.&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Base directory:&#39;</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">)</span>

<span class="c1"># Insert the package_dir_a directory at the front of the path.</span>
<span class="n">package_dir_a</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;package_dir_a&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">package_dir_a</span><span class="p">)</span>

<span class="c1"># Import the example module</span>
<span class="kn">import</span> <span class="nn">example</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Imported example from:&#39;</span><span class="p">,</span> <span class="n">example</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">example</span><span class="o">.</span><span class="n">DATA</span><span class="p">)</span>

<span class="c1"># Make package_dir_b the first directory in the search path</span>
<span class="n">package_dir_b</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;package_dir_b&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">package_dir_b</span><span class="p">)</span>

<span class="c1"># Reload the module to get the other version</span>
<span class="n">importlib</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reloaded example from:&#39;</span><span class="p">,</span> <span class="n">example</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">example</span><span class="o">.</span><span class="n">DATA</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Reloading an imported module re-imports the file, and uses the same
<code class="docutils literal notranslate"><span class="pre">module</span></code> object to hold the results.  Changing the path between
the initial import and the call to <code class="docutils literal notranslate"><span class="pre">reload()</span></code> means a different
module may be loaded the second time.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 sys_path_modify.py

Base directory: .
Imported example from: ./package_dir_a/example.py
   This is example A
Reloaded example from: ./package_dir_b/example.py
   This is example B
</pre></div>
</div>
</div>
<div class="section" id="custom-importers">
<h2>Custom Importers<a class="headerlink" href="#custom-importers" title="Permalink to this headline">¶</a></h2>
<p>Modifying the search path lets a programmer control how standard
Python modules are found. But, what if a program needs to import code
from somewhere other than the usual <code class="docutils literal notranslate"><span class="pre">.py</span></code> or <code class="docutils literal notranslate"><span class="pre">.pyc</span></code> files on the
file system? <span class="target" id="index-0"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0302"><strong>PEP 302</strong></a> solves this problem by introducing the idea of
<em>import hooks</em>, which can trap an attempt to find a module on the
search path and take alternative measures to load the code from
somewhere else or apply pre-processing to it.</p>
<p>Custom importers are implemented in two separate phases. The <em>finder</em>
is responsible for locating a module and providing a <em>loader</em> to
manage the actual import. Custom module finders are added
by appending a factory to the <code class="docutils literal notranslate"><span class="pre">sys.path_hooks</span></code> list. On import,
each part of the path is given to a finder until one claims support
(by not raising <code class="docutils literal notranslate"><span class="pre">ImportError</span></code>). That
finder is then responsible for searching data storage represented by
its path entry for named modules.</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">sys_path_hooks_noisy.py</span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>


<span class="k">class</span> <span class="nc">NoisyImportFinder</span><span class="p">:</span>

    <span class="n">PATH_TRIGGER</span> <span class="o">=</span> <span class="s1">&#39;NoisyImportFinder_PATH_TRIGGER&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_entry</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking </span><span class="si">{}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_entry</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path_entry</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATH_TRIGGER</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;wrong finder&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;works&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">find_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Looking for </span><span class="si">{!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fullname</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="n">sys</span><span class="o">.</span><span class="n">path_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NoisyImportFinder</span><span class="p">)</span>

<span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path_hooks</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Path hook: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hook</span><span class="p">))</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NoisyImportFinder</span><span class="o">.</span><span class="n">PATH_TRIGGER</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;importing target_module&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">target_module</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Import failed:&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>This example illustrates how the finders are instantiated and
queried. The <code class="docutils literal notranslate"><span class="pre">NoisyImportFinder</span></code> raises <code class="docutils literal notranslate"><span class="pre">ImportError</span></code>
when instantiated with a path entry that
does not match its special trigger value, which is obviously not a
real path on the file system. This test prevents the
<code class="docutils literal notranslate"><span class="pre">NoisyImportFinder</span></code> from breaking imports of real modules.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 sys_path_hooks_noisy.py

Path hook: &lt;class &#39;zipimport.zipimporter&#39;&gt;
Path hook: &lt;function
FileFinder.path_hook.&lt;locals&gt;.path_hook_for_FileFinder at
0x101afb6a8&gt;
Path hook: &lt;class &#39;__main__.NoisyImportFinder&#39;&gt;
importing target_module
Checking NoisyImportFinder_PATH_TRIGGER: works
Looking for &#39;target_module&#39;
Import failed: No module named &#39;target_module&#39;
</pre></div>
</div>
</div>
<div class="section" id="importing-from-a-shelve">
<h2>Importing from a Shelve<a class="headerlink" href="#importing-from-a-shelve" title="Permalink to this headline">¶</a></h2>
<p>When the finder locates a module, it is responsible for returning a
<em>loader</em> capable of importing that module.  This example illustrates a
custom importer that saves its module contents in a database created
by <a class="reference internal" href="../shelve/index.html#module-shelve" title="shelve: Persistent storage of objects"><code class="xref py py-mod docutils literal notranslate"><span class="pre">shelve</span></code></a>.</p>
<p>First, a script is used to populate the shelf with a package
containing a sub-module and sub-package.</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">sys_shelve_importer_create.py</span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">shelve</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;/tmp/pymotw_import_example.shelve&#39;</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.db&#39;</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.db&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
    <span class="n">db</span><span class="p">[</span><span class="s1">&#39;data:README&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">==============</span>
<span class="s2">package README</span>
<span class="s2">==============</span>

<span class="s2">This is the README for ``package``.</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">db</span><span class="p">[</span><span class="s1">&#39;package.__init__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">print(&#39;package imported&#39;)</span>
<span class="s2">message = &#39;This message is in package.__init__&#39;</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">db</span><span class="p">[</span><span class="s1">&#39;package.module1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">print(&#39;package.module1 imported&#39;)</span>
<span class="s2">message = &#39;This message is in package.module1&#39;</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">db</span><span class="p">[</span><span class="s1">&#39;package.subpackage.__init__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">print(&#39;package.subpackage imported&#39;)</span>
<span class="s2">message = &#39;This message is in package.subpackage.__init__&#39;</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">db</span><span class="p">[</span><span class="s1">&#39;package.subpackage.module2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">print(&#39;package.subpackage.module2 imported&#39;)</span>
<span class="s2">message = &#39;This message is in package.subpackage.module2&#39;</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">db</span><span class="p">[</span><span class="s1">&#39;package.with_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">print(&#39;package.with_error being imported&#39;)</span>
<span class="s2">raise ValueError(&#39;raising exception to break import&#39;)</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Created </span><span class="si">{}</span><span class="s1"> with:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>A real packaging script would read the contents from the file system,
but using hard-coded values is sufficient for a simple example like
this.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 sys_shelve_importer_create.py

Created /tmp/pymotw_import_example.shelve with:
   data:README
   package.__init__
   package.module1
   package.subpackage.__init__
   package.subpackage.module2
   package.with_error
</pre></div>
</div>
<p>The custom importer needs to provide finder and loader classes that
know how to look in a shelf for the source of a module or package.</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">sys_shelve_importer.py</span><a class="headerlink" href="#id7" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">imp</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shelve</span>
<span class="kn">import</span> <span class="nn">sys</span>


<span class="k">def</span> <span class="nf">_mk_init_name</span><span class="p">(</span><span class="n">fullname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the name of the __init__ module</span>
<span class="sd">    for a given package name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">fullname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.__init__&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fullname</span>
    <span class="k">return</span> <span class="n">fullname</span> <span class="o">+</span> <span class="s1">&#39;.__init__&#39;</span>


<span class="k">def</span> <span class="nf">_get_key_name</span><span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Look in an open shelf for fullname or</span>
<span class="sd">    fullname.__init__, return the name found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">fullname</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fullname</span>
    <span class="n">init_name</span> <span class="o">=</span> <span class="n">_mk_init_name</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">init_name</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">init_name</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">ShelveFinder</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Find modules collected in a shelve archive.&quot;&quot;&quot;</span>

    <span class="n">_maybe_recursing</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_entry</span><span class="p">):</span>
        <span class="c1"># Loading shelve causes an import recursive loop when it</span>
        <span class="c1"># imports dbm, and we know we are not going to load the</span>
        <span class="c1"># module # being imported, so when we seem to be</span>
        <span class="c1"># recursing just ignore the request so another finder</span>
        <span class="c1"># will be used.</span>
        <span class="k">if</span> <span class="n">ShelveFinder</span><span class="o">.</span><span class="n">_maybe_recursing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Test the path_entry to see if it is a valid shelf</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ShelveFinder</span><span class="o">.</span><span class="n">_maybe_recursing</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">with</span> <span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path_entry</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">):</span>
                    <span class="k">pass</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">ShelveFinder</span><span class="o">.</span><span class="n">_maybe_recursing</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;shelf could not import from </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">path_entry</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;shelf added to import path:&#39;</span><span class="p">,</span> <span class="n">path_entry</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_entry</span> <span class="o">=</span> <span class="n">path_entry</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">{}</span><span class="s1"> for </span><span class="si">{!r}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">path_entry</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">find_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_entry</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">looking for </span><span class="si">{!r}</span><span class="se">\n</span><span class="s1">  in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">fullname</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">with</span> <span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_entry</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
            <span class="n">key_name</span> <span class="o">=</span> <span class="n">_get_key_name</span><span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key_name</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  found it as </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key_name</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">ShelveLoader</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  not found&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">ShelveLoader</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Load source for modules from shelve databases.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_entry</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_entry</span> <span class="o">=</span> <span class="n">path_entry</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_get_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">):</span>
        <span class="c1"># Make up a fake filename that starts with the path entry</span>
        <span class="c1"># so pkgutil.get_data() works correctly.</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_entry</span><span class="p">,</span> <span class="n">fullname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;loading source for </span><span class="si">{!r}</span><span class="s1"> from shelf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">fullname</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_entry</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
                <span class="n">key_name</span> <span class="o">=</span> <span class="n">_get_key_name</span><span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key_name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">db</span><span class="p">[</span><span class="n">key_name</span><span class="p">]</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                    <span class="s1">&#39;could not find source for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">fullname</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;could not load source:&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">):</span>
        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;compiling code for </span><span class="si">{!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fullname</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">compile</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_filename</span><span class="p">(</span><span class="n">fullname</span><span class="p">),</span>
                       <span class="s1">&#39;exec&#39;</span><span class="p">,</span> <span class="n">dont_inherit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;looking for data</span><span class="se">\n</span><span class="s1">  in </span><span class="si">{}</span><span class="se">\n</span><span class="s1">  for </span><span class="si">{!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_entry</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_entry</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_entry</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="n">key_name</span> <span class="o">=</span> <span class="s1">&#39;data:&#39;</span> <span class="o">+</span> <span class="n">path</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_entry</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">db</span><span class="p">[</span><span class="n">key_name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Convert all errors to IOError</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">is_package</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">):</span>
        <span class="n">init_name</span> <span class="o">=</span> <span class="n">_mk_init_name</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_entry</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">init_name</span> <span class="ow">in</span> <span class="n">db</span>

    <span class="k">def</span> <span class="nf">load_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">):</span>
        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fullname</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reusing module from import of </span><span class="si">{!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">fullname</span><span class="p">))</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">fullname</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;creating a new module object for </span><span class="si">{!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">fullname</span><span class="p">))</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                <span class="n">fullname</span><span class="p">,</span>
                <span class="n">imp</span><span class="o">.</span><span class="n">new_module</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Set a few properties required by PEP 302</span>
        <span class="n">mod</span><span class="o">.</span><span class="vm">__file__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_filename</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
        <span class="n">mod</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">fullname</span>
        <span class="n">mod</span><span class="o">.</span><span class="n">__path__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_entry</span>
        <span class="n">mod</span><span class="o">.</span><span class="n">__loader__</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="c1"># PEP-366 specifies that package&#39;s set __package__ to</span>
        <span class="c1"># their name, and modules have it set to their parent</span>
        <span class="c1"># package (if any).</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_package</span><span class="p">(</span><span class="n">fullname</span><span class="p">):</span>
            <span class="n">mod</span><span class="o">.</span><span class="n">__package__</span> <span class="o">=</span> <span class="n">fullname</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mod</span><span class="o">.</span><span class="n">__package__</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fullname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_package</span><span class="p">(</span><span class="n">fullname</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;adding path for package&#39;</span><span class="p">)</span>
            <span class="c1"># Set __path__ for packages</span>
            <span class="c1"># so we can find the sub-modules.</span>
            <span class="n">mod</span><span class="o">.</span><span class="n">__path__</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">path_entry</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;imported as regular module&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;execing source...&#39;</span><span class="p">)</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">mod</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mod</span>
</pre></div>
</div>
</div>
<p>Now <code class="docutils literal notranslate"><span class="pre">ShelveFinder</span></code> and <code class="docutils literal notranslate"><span class="pre">ShelveLoader</span></code> can be used to
import code from a shelf. For example, importing the <code class="xref py py-mod docutils literal notranslate"><span class="pre">package</span></code>
just created:</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">sys_shelve_importer_package.py</span><a class="headerlink" href="#id8" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">sys_shelve_importer</span>


<span class="k">def</span> <span class="nf">show_module_details</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  message    :&#39;</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  __name__   :&#39;</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  __package__:&#39;</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="n">__package__</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  __file__   :&#39;</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  __path__   :&#39;</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="n">__path__</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  __loader__ :&#39;</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="n">__loader__</span><span class="p">)</span>


<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;/tmp/pymotw_import_example.shelve&#39;</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys_shelve_importer</span><span class="o">.</span><span class="n">ShelveFinder</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Import of &quot;package&quot;:&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">package</span>

<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Examine package details:&#39;</span><span class="p">)</span>
<span class="n">show_module_details</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Global settings:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sys.modules entry:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;package&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>The shelf is added to the import path the first time an import occurs
after the path is modified. The finder recognizes the shelf and
returns a loader, which is used for all imports from that shelf. The
initial package-level import creates a new module object and then uses
<code class="docutils literal notranslate"><span class="pre">exec</span></code> to run the source loaded from the shelf. It uses the
new module as the namespace so that names defined in the source are
preserved as module-level attributes.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 sys_shelve_importer_package.py

Import of &quot;package&quot;:
shelf added to import path: /tmp/pymotw_import_example.shelve

looking for &#39;package&#39;
  in /tmp/pymotw_import_example.shelve
  found it as package.__init__
loading source for &#39;package&#39; from shelf
creating a new module object for &#39;package&#39;
adding path for package
execing source...
package imported
done

Examine package details:
  message    : This message is in package.__init__
  __name__   : package
  __package__: package
  __file__   : /tmp/pymotw_import_example.shelve/package
  __path__   : [&#39;/tmp/pymotw_import_example.shelve&#39;]
  __loader__ : &lt;sys_shelve_importer.ShelveLoader object at
0x104589b70&gt;

Global settings:
sys.modules entry:
&lt;module &#39;package&#39; (&lt;sys_shelve_importer.ShelveLoader object at
0x104589b70&gt;)&gt;
</pre></div>
</div>
</div>
<div class="section" id="custom-package-importing">
<h2>Custom Package Importing<a class="headerlink" href="#custom-package-importing" title="Permalink to this headline">¶</a></h2>
<p>Loading other modules and sub-packages proceeds in the same way.</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">sys_shelve_importer_module.py</span><a class="headerlink" href="#id9" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">sys_shelve_importer</span>


<span class="k">def</span> <span class="nf">show_module_details</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  message    :&#39;</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  __name__   :&#39;</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  __package__:&#39;</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="n">__package__</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  __file__   :&#39;</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  __path__   :&#39;</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="n">__path__</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  __loader__ :&#39;</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="n">__loader__</span><span class="p">)</span>


<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;/tmp/pymotw_import_example.shelve&#39;</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys_shelve_importer</span><span class="o">.</span><span class="n">ShelveFinder</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Import of &quot;package.module1&quot;:&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">package.module1</span>

<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Examine package.module1 details:&#39;</span><span class="p">)</span>
<span class="n">show_module_details</span><span class="p">(</span><span class="n">package</span><span class="o">.</span><span class="n">module1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Import of &quot;package.subpackage.module2&quot;:&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">package.subpackage.module2</span>

<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Examine package.subpackage.module2 details:&#39;</span><span class="p">)</span>
<span class="n">show_module_details</span><span class="p">(</span><span class="n">package</span><span class="o">.</span><span class="n">subpackage</span><span class="o">.</span><span class="n">module2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The finder receives the entire dotted name of the module to load, and
returns a <code class="docutils literal notranslate"><span class="pre">ShelveLoader</span></code> configured to load modules from the
path entry pointing to the shelf file.  The fully qualified module
name is passed to the loader’s <code class="xref py py-meth docutils literal notranslate"><span class="pre">load_module()</span></code> method, which
constructs and returns a <code class="docutils literal notranslate"><span class="pre">module</span></code> instance.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 sys_shelve_importer_module.py

Import of &quot;package.module1&quot;:
shelf added to import path: /tmp/pymotw_import_example.shelve

looking for &#39;package&#39;
  in /tmp/pymotw_import_example.shelve
  found it as package.__init__
loading source for &#39;package&#39; from shelf
creating a new module object for &#39;package&#39;
adding path for package
execing source...
package imported
done

looking for &#39;package.module1&#39;
  in /tmp/pymotw_import_example.shelve
  found it as package.module1
loading source for &#39;package.module1&#39; from shelf
creating a new module object for &#39;package.module1&#39;
imported as regular module
execing source...
package.module1 imported
done

Examine package.module1 details:
  message    : This message is in package.module1
  __name__   : package.module1
  __package__: package
  __file__   : /tmp/pymotw_import_example.shelve/package.module1
  __path__   : /tmp/pymotw_import_example.shelve
  __loader__ : &lt;sys_shelve_importer.ShelveLoader object at
0x10457dc18&gt;

Import of &quot;package.subpackage.module2&quot;:

looking for &#39;package.subpackage&#39;
  in /tmp/pymotw_import_example.shelve
  found it as package.subpackage.__init__
loading source for &#39;package.subpackage&#39; from shelf
creating a new module object for &#39;package.subpackage&#39;
adding path for package
execing source...
package.subpackage imported
done

looking for &#39;package.subpackage.module2&#39;
  in /tmp/pymotw_import_example.shelve
  found it as package.subpackage.module2
loading source for &#39;package.subpackage.module2&#39; from shelf
creating a new module object for &#39;package.subpackage.module2&#39;
imported as regular module
execing source...
package.subpackage.module2 imported
done

Examine package.subpackage.module2 details:
  message    : This message is in package.subpackage.module2
  __name__   : package.subpackage.module2
  __package__: package.subpackage
  __file__   :
/tmp/pymotw_import_example.shelve/package.subpackage.module2
  __path__   : /tmp/pymotw_import_example.shelve
  __loader__ : &lt;sys_shelve_importer.ShelveLoader object at
0x1045b5080&gt;
</pre></div>
</div>
</div>
<div class="section" id="reloading-modules-in-a-custom-importer">
<h2>Reloading Modules in a Custom Importer<a class="headerlink" href="#reloading-modules-in-a-custom-importer" title="Permalink to this headline">¶</a></h2>
<p>Reloading a module is handled slightly differently. Instead of
creating a new module object, the existing object is re-used.</p>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">sys_shelve_importer_reload.py</span><a class="headerlink" href="#id10" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">sys_shelve_importer</span>

<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;/tmp/pymotw_import_example.shelve&#39;</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys_shelve_importer</span><span class="o">.</span><span class="n">ShelveFinder</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;First import of &quot;package&quot;:&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">package</span>

<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reloading &quot;package&quot;:&#39;</span><span class="p">)</span>
<span class="n">importlib</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>By re-using the same object, existing references to the module are
preserved even if class or function definitions are modified by the
reload.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 sys_shelve_importer_reload.py

First import of &quot;package&quot;:
shelf added to import path: /tmp/pymotw_import_example.shelve

looking for &#39;package&#39;
  in /tmp/pymotw_import_example.shelve
  found it as package.__init__
loading source for &#39;package&#39; from shelf
creating a new module object for &#39;package&#39;
adding path for package
execing source...
package imported
done

Reloading &quot;package&quot;:

looking for &#39;package&#39;
  in /tmp/pymotw_import_example.shelve
  found it as package.__init__
loading source for &#39;package&#39; from shelf
reusing module from import of &#39;package&#39;
adding path for package
execing source...
package imported
done
</pre></div>
</div>
</div>
<div class="section" id="handling-import-errors">
<h2>Handling Import Errors<a class="headerlink" href="#handling-import-errors" title="Permalink to this headline">¶</a></h2>
<p>When a module cannot be located by any finder, <code class="docutils literal notranslate"><span class="pre">ImportError</span></code>
is raised by the main import code.</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">sys_shelve_importer_missing.py</span><a class="headerlink" href="#id11" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">sys_shelve_importer</span>

<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;/tmp/pymotw_import_example.shelve&#39;</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys_shelve_importer</span><span class="o">.</span><span class="n">ShelveFinder</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">package.module3</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to import:&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Other errors during the import are propagated.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 sys_shelve_importer_missing.py

shelf added to import path: /tmp/pymotw_import_example.shelve

looking for &#39;package&#39;
  in /tmp/pymotw_import_example.shelve
  found it as package.__init__
loading source for &#39;package&#39; from shelf
creating a new module object for &#39;package&#39;
adding path for package
execing source...
package imported
done

looking for &#39;package.module3&#39;
  in /tmp/pymotw_import_example.shelve
  not found
Failed to import: No module named &#39;package.module3&#39;
</pre></div>
</div>
</div>
<div class="section" id="package-data">
<h2>Package Data<a class="headerlink" href="#package-data" title="Permalink to this headline">¶</a></h2>
<p>In addition to defining the API for loading executable Python code,
PEP 302 defines an optional API for retrieving package data
intended for distributing data files, documentation, and other
non-code resources used by a package. By implementing <code class="docutils literal notranslate"><span class="pre">get_data()</span></code>,
a loader can allow calling applications to support retrieval of data
associated with the package without considering how the package is
actually installed (especially without assuming that the package is
stored as files on a file system).</p>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">sys_shelve_importer_get_data.py</span><a class="headerlink" href="#id12" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">sys_shelve_importer</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pkgutil</span>

<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;/tmp/pymotw_import_example.shelve&#39;</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys_shelve_importer</span><span class="o">.</span><span class="n">ShelveFinder</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">package</span>

<span class="n">readme_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">package</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;README&#39;</span><span class="p">)</span>

<span class="n">readme</span> <span class="o">=</span> <span class="n">pkgutil</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;package&#39;</span><span class="p">,</span> <span class="s1">&#39;README&#39;</span><span class="p">)</span>
<span class="c1"># Equivalent to:</span>
<span class="c1">#  readme = package.__loader__.get_data(readme_path)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">readme</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

<span class="n">foo_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">package</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">foo</span> <span class="o">=</span> <span class="n">pkgutil</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;package&#39;</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
    <span class="c1"># Equivalent to:</span>
    <span class="c1">#  foo = package.__loader__.get_data(foo_path)</span>
<span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: Could not load &quot;foo&quot;&#39;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">get_data()</span></code> takes a path based on the module or package that owns
the data, and returns the contents of the resource “file” as a byte
string, or raises <code class="docutils literal notranslate"><span class="pre">IOError</span></code> if the resource does not exist.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 sys_shelve_importer_get_data.py

shelf added to import path: /tmp/pymotw_import_example.shelve

looking for &#39;package&#39;
  in /tmp/pymotw_import_example.shelve
  found it as package.__init__
loading source for &#39;package&#39; from shelf
creating a new module object for &#39;package&#39;
adding path for package
execing source...
package imported
done
looking for data
  in /tmp/pymotw_import_example.shelve
  for &#39;/tmp/pymotw_import_example.shelve/README&#39;

==============
package README
==============

This is the README for ``package``.

looking for data
  in /tmp/pymotw_import_example.shelve
  for &#39;/tmp/pymotw_import_example.shelve/foo&#39;
ERROR: Could not load &quot;foo&quot;
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<ul class="last simple">
<li><a class="reference internal" href="../pkgutil/index.html#module-pkgutil" title="pkgutil: Package utilities"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pkgutil</span></code></a> – Includes <code class="docutils literal notranslate"><span class="pre">get_data()</span></code> for retrieving data
from a package.</li>
</ul>
</div>
</div>
<div class="section" id="importer-cache">
<h2>Importer Cache<a class="headerlink" href="#importer-cache" title="Permalink to this headline">¶</a></h2>
<p>Searching through all of the hooks each time a module is imported can
become expensive. To save time, <code class="docutils literal notranslate"><span class="pre">sys.path_importer_cache</span></code> is
maintained as a mapping between a path entry and the loader that can
use the value to find modules.</p>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text">sys_path_importer_cache.py</span><a class="headerlink" href="#id13" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PATH:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;...&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;IMPORTERS:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">cache_value</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path_importer_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="s1">&#39;..&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;...&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{}</span><span class="s1">: </span><span class="si">{!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cache_value</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">FileFinder</span></code> is used for path locations found on the file
system. Locations on the path not supported by any finder are
associated with a <code class="docutils literal notranslate"><span class="pre">None</span></code>, since they cannot be used to import
modules. The output below has been truncated due to formatting
constraints.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 sys_path_importer_cache.py

PATH:
  /Users/dhellmann/Documents/PyMOTW/Python3/pymotw-3/source/sys
  .../lib/python35.zip
  .../lib/python3.5
  .../lib/python3.5/plat-darwin
  .../lib/python3.5/lib-dynload
  .../lib/python3.5/site-packages

IMPORTERS:
  sys_path_importer_cache.py: None
  .../lib/python3.5/encodings: FileFinder(
  &#39;.../lib/python3.5/encodings&#39;)
  .../lib/python3.5/lib-dynload: FileFinder(
  &#39;.../lib/python3.5/lib-dynload&#39;)
  .../lib/python3.5/lib-dynload: FileFinder(
  &#39;.../lib/python3.5/lib-dynload&#39;)
  .../lib/python3.5/site-packages: FileFinder(
  &#39;.../lib/python3.5/site-packages&#39;)
  .../lib/python3.5: FileFinder(
  &#39;.../lib/python3.5/&#39;)
  .../lib/python3.5/plat-darwin: FileFinder(
  &#39;.../lib/python3.5/plat-darwin&#39;)
  .../lib/python3.5: FileFinder(
  &#39;.../lib/python3.5&#39;)
  .../lib/python35.zip: None
  .../lib/python3.5/plat-darwin: FileFinder(
  &#39;.../lib/python3.5/plat-darwin&#39;)
</pre></div>
</div>
</div>
<div class="section" id="meta-path">
<h2>Meta Path<a class="headerlink" href="#meta-path" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">sys.meta_path</span></code> further extends the sources of potential
imports by allowing a finder to be searched <em>before</em> the regular
<code class="docutils literal notranslate"><span class="pre">sys.path</span></code> is scanned. The API for a finder on the meta-path is
the same as for a regular path. The difference is that the metafinder
is not limited to a single entry in <code class="docutils literal notranslate"><span class="pre">sys.path</span></code> – it can search
anywhere at all.</p>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-text">sys_meta_path.py</span><a class="headerlink" href="#id14" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">types</span>


<span class="k">class</span> <span class="nc">NoisyMetaImportFinder</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating NoisyMetaImportFinder for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">prefix</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">find_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;looking for </span><span class="si">{!r}</span><span class="s1"> with path </span><span class="si">{!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">fullname</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="n">name_parts</span> <span class="o">=</span> <span class="n">fullname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name_parts</span> <span class="ow">and</span> <span class="n">name_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; ... found prefix, returning loader&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">NoisyMetaImportLoader</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; ... not the right prefix, cannot load&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">NoisyMetaImportLoader</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_entry</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_entry</span> <span class="o">=</span> <span class="n">path_entry</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">load_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;loading </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fullname</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">fullname</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">fullname</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                <span class="n">fullname</span><span class="p">,</span>
                <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">(</span><span class="n">fullname</span><span class="p">))</span>

        <span class="c1"># Set a few properties required by PEP 302</span>
        <span class="n">mod</span><span class="o">.</span><span class="vm">__file__</span> <span class="o">=</span> <span class="n">fullname</span>
        <span class="n">mod</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">fullname</span>
        <span class="c1"># always looks like a package</span>
        <span class="n">mod</span><span class="o">.</span><span class="n">__path__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;path-entry-goes-here&#39;</span><span class="p">]</span>
        <span class="n">mod</span><span class="o">.</span><span class="n">__loader__</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">mod</span><span class="o">.</span><span class="n">__package__</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fullname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">mod</span>


<span class="c1"># Install the meta-path finder</span>
<span class="n">sys</span><span class="o">.</span><span class="n">meta_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NoisyMetaImportFinder</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">))</span>

<span class="c1"># Import some modules that are &quot;found&quot; by the meta-path finder</span>
<span class="nb">print</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">foo</span>

<span class="nb">print</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">foo.bar</span>

<span class="c1"># Import a module that is not found</span>
<span class="nb">print</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">bar</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
<p>Each finder on the meta-path is interrogated before <code class="docutils literal notranslate"><span class="pre">sys.path</span></code>
is searched, so there is always an opportunity to have a central
importer load modules without explicitly modifying <code class="docutils literal notranslate"><span class="pre">sys.path</span></code>.
Once the module is “found,” the loader API works in the same way as
for regular loaders (although this example is truncated for
simplicity).</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 sys_meta_path.py

Creating NoisyMetaImportFinder for foo

looking for &#39;foo&#39; with path None
 ... found prefix, returning loader
loading foo

looking for &#39;foo.bar&#39; with path [&#39;path-entry-goes-here&#39;]
 ... found prefix, returning loader
loading foo.bar

looking for &#39;bar&#39; with path None
 ... not the right prefix, cannot load
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<ul class="last simple">
<li><a class="reference internal" href="../importlib/index.html#module-importlib" title="importlib: Interface to module import mechanism."><code class="xref py py-mod docutils literal notranslate"><span class="pre">importlib</span></code></a> – Base classes and other tools for creating
custom importers.</li>
<li><a class="reference internal" href="../zipimport/index.html#module-zipimport" title="zipimport: Load Python code from ZIP archives."><code class="xref py py-mod docutils literal notranslate"><span class="pre">zipimport</span></code></a> – Implements importing Python modules from
inside ZIP archives.</li>
<li><a class="reference external" href="http://setuptools.readthedocs.io/en/latest/formats.html?highlight=egg">The Internal Structure of Python Eggs</a>
– setuptools documentation for the egg format</li>
<li><a class="reference external" href="http://wheel.readthedocs.org/en/latest/">Wheel</a> –
Documentation for <code class="docutils literal notranslate"><span class="pre">wheel</span></code> archive format for installable
Python code.</li>
<li><span class="target" id="index-1"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0302"><strong>PEP 302</strong></a> – Import Hooks</li>
<li><span class="target" id="index-2"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0366"><strong>PEP 366</strong></a> – Main module explicit relative imports</li>
<li><span class="target" id="index-3"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0427"><strong>PEP 427</strong></a> – The Wheel Binary Package Format 1.0</li>
<li><a class="reference external" href="http://pyvideo.org/pycon-us-2010/pycon-2010--import-this--that--and-the-other-thin.html">Import this, that, and the other thing: custom importers</a> –
Brett Cannon’s PyCon 2010 presentation.</li>
</ul>
</div>
</div>
</div>



        <div id="footer-nav">
<a id="prev-link" href="threads.html"
   title="previous chapter"><i class="fa fa-arrow-circle-left"></i> Low-level Thread Support</a>
<a id="next-link" href="tracing.html"
   title="next chapter">Tracing a Program As It Runs <i class="fa fa-arrow-circle-right"></i></a>
        </div>

        </div>
      </div>

      <div class="pure-u-1-4">
        <div class="sidebar-wrapper">
          <div class="sidebar">
<div id="sidebar-toc">
  <h5>Quick Links</h5>
  <ul>
    
    <li><a href="#imported-modules"><i class="fa fa-caret-right"></i>Imported Modules</a></li>
    
    <li><a href="#built-in-modules"><i class="fa fa-caret-right"></i>Built-in Modules</a></li>
    
    <li><a href="#import-path"><i class="fa fa-caret-right"></i>Import Path</a></li>
    
    <li><a href="#custom-importers"><i class="fa fa-caret-right"></i>Custom Importers</a></li>
    
    <li><a href="#importing-from-a-shelve"><i class="fa fa-caret-right"></i>Importing from a Shelve</a></li>
    
    <li><a href="#custom-package-importing"><i class="fa fa-caret-right"></i>Custom Package Importing</a></li>
    
    <li><a href="#reloading-modules-in-a-custom-importer"><i class="fa fa-caret-right"></i>Reloading Modules in a Custom Importer</a></li>
    
    <li><a href="#handling-import-errors"><i class="fa fa-caret-right"></i>Handling Import Errors</a></li>
    
    <li><a href="#package-data"><i class="fa fa-caret-right"></i>Package Data</a></li>
    
    <li><a href="#importer-cache"><i class="fa fa-caret-right"></i>Importer Cache</a></li>
    
    <li><a href="#meta-path"><i class="fa fa-caret-right"></i>Meta Path</a></li>
    
  </ul>
</div>

          </div>
          <div class="sidebar"><div id="sidebar-last-updated">
  This page was last updated 2018-12-09.
</div>

          </div>
          <div class="sidebar">
<div id="sidebar-nav">
  <h5>Navigation</h5>
  <ul>
    <li><a href="threads.html"
           title="previous chapter"><i class="fa fa-arrow-circle-left"></i>Low-level Thread Support</a></li>
    <li><a href="tracing.html"
           title="next chapter"><i class="fa fa-arrow-circle-right"></i>Tracing a Program As It Runs</a></li>
  </ul>
</div>
          </div>
          <div class="sidebar"><div id="sidebar-book"><a target="new" href="https://doughellmann.com/blog/the-python-3-standard-library-by-example/"><img src="../_static/book-cover-image-med.jpg"><br>Get the book</a></div>
          </div>
          <div class="sidebar"><div id="sidebar-example-disclaimer">
<p>The output from all the example programs
from PyMOTW-3 has been generated with Python 3.7.9, unless
otherwise noted. Some of the features described here may not be
available in earlier versions of Python.</p>
<p>Looking for <a href="/2/">examples for Python 2</a>?</p>
</div>
          </div>

        </div>
      </div>

    </div>

    <div class="pure-g-r" id="footer">

      <div class="pure-u-1-3">
        <div class="footer-list">
            <h4>This Site</h4>
            <ul>
              <li><a href="../py-modindex.html"><i class="fa fa-list fa-lg"></i> Module Index</a></li>
              <li><a href="../genindex.html"><i class="fa fa-italic fa-lg"></i> Index</a></li>
            </ul>
        </div>
      </div><div class="pure-u-1-3">
          <div class="footer-content">
            <div class="socialmedia">
              <a class="sociallink" href="../index.html"
       title="Home">
      <i class="fa fa-home fa-lg"></i></a>
              <a class="sociallink" href="../about.html"
       title="About">
      <i class="fa fa-user fa-lg"></i></a>
              <a class="sociallink" href="http://www.twitter.com/pymotw"
       title="Twitter">
      <i class="fa fa-twitter fa-lg"></i></a>
              <a class="sociallink" href="http://feeds.doughellmann.com/PyMOTW"
       title="Subscribe via RSS">
      <i class="fa fa-rss-square fa-lg"></i></a>
              <a class="sociallink" href="http://feedburner.google.com/fb/a/mailverify?uri=PyMOTW&amp;loc=en_US"
       title="Subscribe via Email">
      <i class="fa fa-envelope fa-lg"></i></a>
            </div>

            <div class="copyright">
              <a rel="author" href="../about.html">&copy; Copyright 2021, Doug Hellmann</a>
            </div>

            <div class="cc"><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/deed.en_US" rel="license"><img alt="Creative Commons License BY-NC-SA" style="border-width:0; align: center;" width="88" height="31" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFgAAAAfCAMAAABUFvrSAAAABGdBTUEAALGOfPtRkwAAAf5QTFRF////////////AAAADQwNDQ4NDg4OEBAQGRkZGxsbHxscICAgIx8gJCQkKCUmKCgoKCkoKSkpKSopKicnKioqLS0tMDAwMS0uMjExMjMxNTY1Pj8+Pzc5Pzs8QEBAQ0RDUFBQUFFQWldYXV5dYGBgY19haGVmbmxscHBwcHJvdXJzdnN0eHV2eXx5en15fH98fX98fnt8f4F+gICAgoWChIGChIWEhIaEh4aHiYyJjIqLjoeLj4+PkY+PkZORkZSRk5iTlZmUlpmWmJaXmpiZnp2dnqCdn5aan5+fn6Oeoqaho6Gho6ijpqqmq7GqrKurrLKrrbOsrrOtrrStr6+vr7Kvr7Sur7WusLOvsLWvsLavsbewsrexsrixs7iytLmztLqztbW1tbq0tru1t7y2uL23ub64ub65urm5ur+5ur+6u8C6u8C7vMC8vMG7vMG8vcK8vcK9vsK9vsO+v7+/v8O+v8S+wMS/wMW/wMXAwcXAwsfCw8fCw8jDxMfDxMjDxMnExcnExcnFxsrFxsrGx8vHyMfHyMzHyMzIycjIyc3Iyc3Jys3Jy8rLy87Ky8/Ky8/LzM/LzNDLzNDMzdDMzdHMzdHNztHNztLOz8/Pz9PP0NPP0NTQ0dTQ0dTR0tXR0tXS09bS1tXV39/f4N/g4+Pj6Ofn7+/v8fHx////rrSdFQAAAAN0Uk5TAAoO5yEBUwAAA+FJREFUSMe1lo9301QUx6uXUmaf0qJ26iTrRoVinUzjQNR1gAyH6Lqx6XTDoVvXbU7qhA5m7CgYWaTDlLa6AiFsba3t+y+9Sdr8OvVMi7zTnLTf5H7ee9/73n11PA1PpDkcADPRWPwKt8YLG2I2n89m7gh8iluJz0dnpqe+HBsdHRn+7w3JyF1cvpbk05mCJG8Xi9uPpMLdNJ9cXV5UyBNjoyMtkR2A3B9Tt8SCfLTTqUzC2XlMvpcRbnA/IPmryYnzoyM9XuWBt8eI21FBcAy5Qk4KtxkGtQ1I+fRNbnk+evHC5NhJDwATDDIAnhNa1ImdFQTHr6WEvNyFPFeATSTYgAu/dl3/I31jNR6bnZ76eDf4yxRb2Q+71aiz/0JB8JXkrZzCdbFVqrUhRHuu54XkytLczAUvBFADUB6ARwnyqEp/t02prK9XdAXBHC9KyPWVqd6qPhyzlOG55dhsL/hLDTD1A3rYAy+dRu6eXaGKruA75wi2hbqigNd+LYSRW6XUSh64l05dXYruA1OPZfAOD3vhObL/ILDvQkRXynSdvPpaiJB+TVHAfEZuA9d9amlVF7TJd3nu+xgwyu8AqNOnDGAM8/obOLhQpWQotPYReZ/SQdKuKQpY2DwKwFJbGwI4VhCSlxchSFUnNC+CCgaV9RAKoZKh1J4le9FmQv5SFQW88aATXGhEws8wrHb7AANc0CndQS+ag5ERaieke0FXvnkxoYL/1MGi7FSmmVBXMDOu3gLK5J2PMjdXv2tmBX6pDdKSkq39DWXh3G1KI4QYVmS3AHCIPnCXE+4hHy6PcfeQ6sV2lufiL2jJ0wasp4p2k/Z2CEXeeqahDBLS1/c8+dBIXq4IkFAiWQ1QtxtnUMz/wsXfBj+1LzdUKn17dvXXzEqfMoFDNWO57QCe22dskKB5g7zXbVN+i0RKumKxonrfzaIVys2wYu7TVrd0PXn1rOnJC4JTFjF5c19/gnXLFwj6jJJz1rOjoi63LnBRfbmNM+qNunG5baSufhu9OPX5my2VTWEzrHrRbIP8dHl+dnpyrIVDBME/q1u6/E9bGmt9i2AsQmeaFaFwIb22soSlfuL8SEtgOCJKB5BsKkNltWyK7zzWMY3X4exDc6GvsljoX5FzR+BxwdCbf3jAdjTJv5/S39H2B2iXpmgXpWB7iVrB0JuVzpgP07CUO2WKqX+oiVL/benKImhgOIzHf7hx/A/IBdHsQ6Nsmruilo4afVFqB8PLn2U2H8hbxeKWjH9YvuiwxNiMaNhALZptCg5d7zh+Sczmclnx0vEOax6ajdjucSMPTcD/97/Cp54Q929ZZbgcR3o0hAAAAABJRU5ErkJggg=="/></a>
            </div>

          </div></div><div class="pure-u-1-3">
          <div class="footer-list">
            <h4>Other Writing</h4>
            <ul>
              <li><a href="https://doughellmann.com/"><i class="fa fa-pencil fa-lg"></i> Blog</a></li>
              <li><a href="https://doughellmann.com/blog/the-python-standard-library-by-example/"><i class="fa fa-book fa-lg"></i> The Python Standard Library By Example</a></li>
            </ul>
          </div>
        </div><script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-38546875-3', 'pymotw.com');
  ga('send', 'pageview');
</script>

  </body>
</html>