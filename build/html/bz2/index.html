<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>bz2 — bzip2 Compression &mdash; PyMOTW 3</title>

    <link rel="stylesheet" href="../_static/pure-min.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/font-awesome/css/font-awesome.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pymotw.css" type="text/css">

    <link rel="shortcut icon" type="image/png" href="../_static/favicon.png">

    <link rel="alternate" type="application/atom+xml"
          title="Doug Hellmann"
          href="http://feeds.doughellmann.com/DougHellmann" />
    <link rel="alternate" type="application/atom+xml"
          title="PyMOTW Updates"
          href="http://feeds.doughellmann.com/PyMOTW" />

    <meta name="verify-v1" content="5saTcOa2HLac4V85yUg3SARfun1PqT5Upu7IR/6fpv4="/>

  </head>
  <body>

    <div class="pure-menu pure-menu-open pure-menu-horizontal" id="site-menu">
      <a class="pure-menu-heading" href="../index.html"><img src="../_static/logo.png"> PyMOTW-3</a>

      <ul id="top-menu">
        <li class="pure-menu-selected"><a href="../py-modindex.html"><i class="fa fa-list fa-lg"></i> Module Index</a></li>
        <li class="pure-menu-selected"><a href="../genindex.html"><i class="fa fa-italic fa-lg"></i> Index</a></li>
        <li class="pure-menu-selected"><a class="sociallink" href="http://www.twitter.com/pymotw"
       title="Twitter">
      <i class="fa fa-twitter fa-lg"></i></a></a>
        <li class="pure-menu-selected"><a class="sociallink" href="http://feeds.doughellmann.com/PyMOTW"
       title="Subscribe via RSS">
      <i class="fa fa-rss-square fa-lg"></i></a></li>
      </ul>

    </div>

    <div class="pure-menu pure-menu-open pure-menu-vertical" id="breadcrumbs-menu">
      
      <ul id="breadcrumbs">
        <li class="pure-menu-selected"><a href="../compression.html"><i class="fa fa-arrow-circle-up"></i> Data Compression and Archiving</a></li>
      </ul>
    </div>

    <div class="pure-g-r" id="content-container">

      <div class="pure-u-3-4">
        <div class="content">
          
  <div class="section" id="module-bz2">
<span id="bz2-bzip2-compression"></span><h1>bz2 — bzip2 Compression<a class="headerlink" href="#module-bz2" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Purpose:</th><td class="field-body">bzip2 compression</td>
</tr>
</tbody>
</table>
<p>The <code class="docutils literal notranslate"><span class="pre">bz2</span></code> module is an interface for the bzip2 library, used to
compress data for storage or transmission.  There are three APIs
provided:</p>
<ul class="simple">
<li>“one shot” compression/decompression functions for operating on a
blob of data</li>
<li>iterative compression/decompression objects for working with streams
of data</li>
<li>a file-like class that supports reading and writing as with an
uncompressed file</li>
</ul>
<div class="section" id="one-shot-operations-in-memory">
<h2>One-shot Operations in Memory<a class="headerlink" href="#one-shot-operations-in-memory" title="Permalink to this headline">¶</a></h2>
<p>The simplest way to work with <code class="docutils literal notranslate"><span class="pre">bz2</span></code> is to load all of the data to
be compressed or decompressed in memory, and then use
<code class="docutils literal notranslate"><span class="pre">compress()</span></code> and <code class="docutils literal notranslate"><span class="pre">decompress()</span></code> to transform it.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">bz2_memory.py</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bz2</span>
<span class="kn">import</span> <span class="nn">binascii</span>

<span class="n">original_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;This is the original text.&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Original     : </span><span class="si">{}</span><span class="s1"> bytes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">original_data</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">original_data</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>
<span class="n">compressed</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">original_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Compressed   : </span><span class="si">{}</span><span class="s1"> bytes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">compressed</span><span class="p">)))</span>
<span class="n">hex_version</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">compressed</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hex_version</span><span class="p">)</span> <span class="o">//</span> <span class="mi">40</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">hex_version</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">40</span><span class="p">:(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">40</span><span class="p">])</span>

<span class="nb">print</span><span class="p">()</span>
<span class="n">decompressed</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">compressed</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Decompressed : </span><span class="si">{}</span><span class="s1"> bytes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">decompressed</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">decompressed</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The compressed data contains non-ASCII characters, so it needs to be
converted to its hexadecimal representation before it can be printed.
In the output from these examples, the hexadecimal version is
reformatted to have at most 40 characters on each line.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 bz2_memory.py

Original     : 26 bytes
b&#39;This is the original text.&#39;

Compressed   : 62 bytes
b&#39;425a683931415926535916be35a6000002938040&#39;
b&#39;01040022e59c402000314c000111e93d434da223&#39;
b&#39;028cf9e73148cae0a0d6ed7f17724538509016be&#39;
b&#39;35a6&#39;

Decompressed : 26 bytes
b&#39;This is the original text.&#39;
</pre></div>
</div>
<p>For short text, the compressed version can be significantly longer
than the original.  While the actual results depend on the input data,
it is interesting to observe the compression overhead.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">bz2_lengths.py</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bz2</span>

<span class="n">original_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;This is the original text.&#39;</span>

<span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:&gt;15}</span><span class="s1">  </span><span class="si">{:&gt;15}</span><span class="s1">&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;len(data)&#39;</span><span class="p">,</span> <span class="s1">&#39;len(compressed)&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">15</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">original_data</span> <span class="o">*</span> <span class="n">i</span>
    <span class="n">compressed</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">compressed</span><span class="p">)),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">compressed</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The output lines ending with <code class="docutils literal notranslate"><span class="pre">*</span></code> show the points where the
compressed data is longer than the raw input.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 bz2_lengths.py

      len(data)  len(compressed)
---------------  ---------------
              0               14*
             26               62*
             52               68*
             78               70
            104               72
</pre></div>
</div>
</div>
<div class="section" id="incremental-compression-and-decompression">
<h2>Incremental Compression and Decompression<a class="headerlink" href="#incremental-compression-and-decompression" title="Permalink to this headline">¶</a></h2>
<p>The in-memory approach has obvious drawbacks that make it impractical
for real-world use cases.  The alternative is to use <code class="docutils literal notranslate"><span class="pre">BZ2Compressor</span></code>
and <code class="docutils literal notranslate"><span class="pre">BZ2Decompressor</span></code> objects to manipulate data incrementally so that
the entire data set does not have to fit into memory.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">bz2_incremental.py</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bz2</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">io</span>

<span class="n">compressor</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2Compressor</span><span class="p">()</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;lorem.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">input</span><span class="p">:</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">block</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">block</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">compressed</span> <span class="o">=</span> <span class="n">compressor</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compressed</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Compressed: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">compressed</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;buffering...&#39;</span><span class="p">)</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="n">compressor</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Flushed: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">remaining</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<p>This example reads small blocks of data from a plain-text file and
passes it to <code class="docutils literal notranslate"><span class="pre">compress()</span></code>.  The compressor maintains an internal
buffer of compressed data.  Since the compression algorithm depends on
checksums and minimum block sizes, the compressor may not be ready to
return data each time it receives more input.  If it does not have an
entire compressed block ready, it returns an empty string.  When all
of the data is fed in, the <code class="docutils literal notranslate"><span class="pre">flush()</span></code> method forces the compressor
to close the final block and return the rest of the compressed data.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 bz2_incremental.py

buffering...
buffering...
buffering...
buffering...
Flushed: b&#39;425a6839314159265359ba83a48c000014d5800010400504052fa
7fe003000ba9112793d4ca789068698a0d1a341901a0d53f4d1119a8d4c9e812
d755a67c10798387682c7ca7b5a3bb75da77755eb81c1cb1ca94c4b6faf209c5
2a90aaa4d16a4a1b9c167a01c8d9ef32589d831e77df7a5753a398b11660e392
126fc18a72a1088716cc8dedda5d489da410748531278043d70a8a131c2b8adc
d6a221bdb8c7ff76b88c1d5342ee48a70a12175074918&#39;
</pre></div>
</div>
</div>
<div class="section" id="mixed-content-streams">
<h2>Mixed Content Streams<a class="headerlink" href="#mixed-content-streams" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">BZ2Decompressor</span></code> can also be used in situations where
compressed and uncompressed data is mixed together.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">bz2_mixed.py</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bz2</span>

<span class="n">lorem</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;lorem.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="n">compressed</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">lorem</span><span class="p">)</span>
<span class="n">combined</span> <span class="o">=</span> <span class="n">compressed</span> <span class="o">+</span> <span class="n">lorem</span>

<span class="n">decompressor</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2Decompressor</span><span class="p">()</span>
<span class="n">decompressed</span> <span class="o">=</span> <span class="n">decompressor</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>

<span class="n">decompressed_matches</span> <span class="o">=</span> <span class="n">decompressed</span> <span class="o">==</span> <span class="n">lorem</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Decompressed matches lorem:&#39;</span><span class="p">,</span> <span class="n">decompressed_matches</span><span class="p">)</span>

<span class="n">unused_matches</span> <span class="o">=</span> <span class="n">decompressor</span><span class="o">.</span><span class="n">unused_data</span> <span class="o">==</span> <span class="n">lorem</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unused data matches lorem :&#39;</span><span class="p">,</span> <span class="n">unused_matches</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>After decompressing all of the data, the <code class="docutils literal notranslate"><span class="pre">unused_data</span></code> attribute
contains any data not used.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 bz2_mixed.py

Decompressed matches lorem: True
Unused data matches lorem : True
</pre></div>
</div>
</div>
<div class="section" id="writing-compressed-files">
<h2>Writing Compressed Files<a class="headerlink" href="#writing-compressed-files" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">BZ2File</span></code> can be used to write to and read from
bzip2-compressed files using the usual methods for writing and reading
data.</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">bz2_file_write.py</span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bz2</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;Contents of the example file go here.</span><span class="se">\n</span><span class="s1">&#39;</span>

<span class="k">with</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="s1">&#39;example.bz2&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">enc</span><span class="p">:</span>
        <span class="n">enc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;file example.bz2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>To write data into a compressed file, open the file with mode
<code class="docutils literal notranslate"><span class="pre">'wb'</span></code>. This example wraps the <code class="docutils literal notranslate"><span class="pre">BZ2File</span></code> with a <code class="docutils literal notranslate"><span class="pre">TextIOWrapper</span></code>
from the <a class="reference internal" href="../io/index.html#module-io" title="io: Implements file I/O and provides classes for working with buffers using file-like API."><code class="xref py py-mod docutils literal notranslate"><span class="pre">io</span></code></a> module to encode Unicode text to bytes suitable for
compression.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 bz2_file_write.py

example.bz2: bzip2 compressed data, block size = 900k
</pre></div>
</div>
<p>Different compression levels can be used by passing a <code class="docutils literal notranslate"><span class="pre">compresslevel</span></code>
argument.  Valid values range from <code class="docutils literal notranslate"><span class="pre">1</span></code> to <code class="docutils literal notranslate"><span class="pre">9</span></code>, inclusive.  Lower values
are faster and result in less compression.  Higher values are slower
and compress more, up to a point.</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">bz2_file_compresslevel.py</span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bz2</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;lorem.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1024</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input contains </span><span class="si">{}</span><span class="s1"> bytes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;compress-level-</span><span class="si">{}</span><span class="s1">.bz2&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">,</span> <span class="n">compresslevel</span><span class="o">=</span><span class="n">i</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">enc</span><span class="p">:</span>
            <span class="n">enc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;cksum </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>The center column of numbers in the output of the script is the size
in bytes of the files produced.  For this input data, the higher
compression values do not always pay off in decreased storage space
for the same input data.  Results will vary for other inputs.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 bz2_file_compresslevel.py

3018243926 8771 compress-level-1.bz2
1942389165 4949 compress-level-2.bz2
2596054176 3708 compress-level-3.bz2
1491394456 2705 compress-level-4.bz2
1425874420 2705 compress-level-5.bz2
2232840816 2574 compress-level-6.bz2
447681641 2394 compress-level-7.bz2
3699654768 1137 compress-level-8.bz2
3103658384 1137 compress-level-9.bz2
Input contains 754688 bytes
</pre></div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">BZ2File</span></code> instance also includes a <code class="docutils literal notranslate"><span class="pre">writelines()</span></code>
method that can be used to write a sequence of strings.</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">bz2_file_writelines.py</span><a class="headerlink" href="#id7" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bz2</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;The same line, over and over.</span><span class="se">\n</span><span class="s1">&#39;</span>

<span class="k">with</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="s1">&#39;lines.bz2&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">enc</span><span class="p">:</span>
        <span class="n">enc</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;bzcat lines.bz2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The lines should end in a newline character, as when writing to a
regular file.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 bz2_file_writelines.py

The same line, over and over.
The same line, over and over.
The same line, over and over.
The same line, over and over.
The same line, over and over.
The same line, over and over.
The same line, over and over.
The same line, over and over.
The same line, over and over.
The same line, over and over.
</pre></div>
</div>
</div>
<div class="section" id="reading-compressed-files">
<h2>Reading Compressed Files<a class="headerlink" href="#reading-compressed-files" title="Permalink to this headline">¶</a></h2>
<p>To read data back from previously compressed files, open the file with
read mode (<code class="docutils literal notranslate"><span class="pre">'rb'</span></code>). The value returned from <code class="docutils literal notranslate"><span class="pre">read()</span></code> will be a
byte string.</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">bz2_file_read.py</span><a class="headerlink" href="#id8" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bz2</span>
<span class="kn">import</span> <span class="nn">io</span>

<span class="k">with</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="s1">&#39;example.bz2&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">input</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dec</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">dec</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
</div>
<p>This example reads the file written by <code class="docutils literal notranslate"><span class="pre">bz2_file_write.py</span></code> from the
previous section. The <code class="docutils literal notranslate"><span class="pre">BZ2File</span></code> is wrapped with a <code class="docutils literal notranslate"><span class="pre">TextIOWrapper</span></code>
to decode bytes read to Unicode text.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 bz2_file_read.py

Contents of the example file go here.
</pre></div>
</div>
<p>While reading a file, it is also possible to seek, and to read only part
of the data.</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">bz2_file_seek.py</span><a class="headerlink" href="#id9" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bz2</span>
<span class="kn">import</span> <span class="nn">contextlib</span>

<span class="k">with</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="s1">&#39;example.bz2&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">input</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Entire file:&#39;</span><span class="p">)</span>
    <span class="n">all_data</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">all_data</span><span class="p">)</span>

    <span class="n">expected</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">15</span><span class="p">]</span>

    <span class="c1"># rewind to beginning</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># move ahead 5 bytes</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting at position 5 for 10 bytes:&#39;</span><span class="p">)</span>
    <span class="n">partial</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">partial</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">expected</span> <span class="o">==</span> <span class="n">partial</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">seek()</span></code> position is relative to the <em>uncompressed</em> data, so
the caller does not need to be aware that the data file is compressed.
This allows a <code class="docutils literal notranslate"><span class="pre">BZ2File</span></code> instance to be passed to a function
expecting a regular uncompressed file.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 bz2_file_seek.py

Entire file:
b&#39;Contents of the example file go here.\n&#39;
Starting at position 5 for 10 bytes:
b&#39;nts of the&#39;

True
</pre></div>
</div>
</div>
<div class="section" id="reading-and-writing-unicode-data">
<h2>Reading and Writing Unicode Data<a class="headerlink" href="#reading-and-writing-unicode-data" title="Permalink to this headline">¶</a></h2>
<p>The previous examples used <code class="docutils literal notranslate"><span class="pre">BZ2File</span></code> directly and managed the
encoding and decoding of Unicode text strings inline with an
<code class="docutils literal notranslate"><span class="pre">io.TextIOWrapper</span></code>, where necessary. These extra steps can be
avoided by using <code class="docutils literal notranslate"><span class="pre">bz2.open()</span></code>, which sets up an
<code class="docutils literal notranslate"><span class="pre">io.TextIOWrapper</span></code> to handle the encoding or decoding
automatically.</p>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">bz2_unicode.py</span><a class="headerlink" href="#id10" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bz2</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;Character with an åccent.&#39;</span>

<span class="k">with</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;example.bz2&#39;</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">with</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;example.bz2&#39;</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">input</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Full file: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>

<span class="c1"># Move to the beginning of the accented character.</span>
<span class="k">with</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;example.bz2&#39;</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">input</span><span class="p">:</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;One character: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>

<span class="c1"># Move to the middle of the accented character.</span>
<span class="k">with</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;example.bz2&#39;</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">input</span><span class="p">:</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: failed to decode&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The file handle returned by <code class="docutils literal notranslate"><span class="pre">open()</span></code> supports <code class="docutils literal notranslate"><span class="pre">seek()</span></code>, but
use care because the file pointer moves by <em>bytes</em> not <em>characters</em>
and may end up in the middle of an encoded character.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 bz2_unicode.py

Full file: Character with an åccent.
One character: å
ERROR: failed to decode
</pre></div>
</div>
</div>
<div class="section" id="compressing-network-data">
<h2>Compressing Network Data<a class="headerlink" href="#compressing-network-data" title="Permalink to this headline">¶</a></h2>
<p>The code in the next example responds to requests consisting of
filenames by writing a compressed version of the file to the socket
used to communicate with the client.  It has some artificial chunking
in place to illustrate the buffering that occurs when the data passed
to <code class="docutils literal notranslate"><span class="pre">compress()</span></code> or <code class="docutils literal notranslate"><span class="pre">decompress()</span></code> does not result in a
complete block of compressed or uncompressed output.</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">bz2_server.py</span><a class="headerlink" href="#id11" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bz2</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">socketserver</span>
<span class="kn">import</span> <span class="nn">binascii</span>

<span class="n">BLOCK_SIZE</span> <span class="o">=</span> <span class="mi">32</span>


<span class="k">class</span> <span class="nc">Bz2RequestHandler</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">BaseRequestHandler</span><span class="p">):</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Server&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">compressor</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2Compressor</span><span class="p">()</span>

        <span class="c1"># Find out what file the client wants</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;client asked for: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="c1"># Send chunks of the file as they are compressed</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">input</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">block</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BLOCK_SIZE</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">block</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;RAW </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
                <span class="n">compressed</span> <span class="o">=</span> <span class="n">compressor</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">compressed</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s1">&#39;SENDING </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">compressed</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">compressed</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;BUFFERING&#39;</span><span class="p">)</span>

        <span class="c1"># Send any data being buffered by the compressor</span>
        <span class="n">remaining</span> <span class="o">=</span> <span class="n">compressor</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">remaining</span><span class="p">:</span>
            <span class="n">to_send</span> <span class="o">=</span> <span class="n">remaining</span><span class="p">[:</span><span class="n">BLOCK_SIZE</span><span class="p">]</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="n">remaining</span><span class="p">[</span><span class="n">BLOCK_SIZE</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;FLUSHING </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">,</span>
                              <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">to_send</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">to_send</span><span class="p">)</span>
        <span class="k">return</span>
</pre></div>
</div>
</div>
<p>The main program starts a server in a thread, combining
<code class="xref py py-mod docutils literal notranslate"><span class="pre">SocketServer</span></code> and <code class="docutils literal notranslate"><span class="pre">Bz2RequestHandler</span></code>.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">socket</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="n">StringIO</span>
    <span class="kn">import</span> <span class="nn">threading</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                        <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="p">)</span>

    <span class="c1"># Set up a server, running in a separate thread</span>
    <span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># let the kernel assign a port</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">socketserver</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">Bz2RequestHandler</span><span class="p">)</span>
    <span class="n">ip</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">server_address</span>  <span class="c1"># what port was assigned?</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Client&#39;</span><span class="p">)</span>

    <span class="c1"># Connect to the server</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Contacting server on </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>

    <span class="c1"># Ask for a file</span>
    <span class="n">requested_file</span> <span class="o">=</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
                      <span class="k">else</span> <span class="s1">&#39;lorem.txt&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;sending filename: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="n">requested_file</span><span class="p">)</span>
    <span class="n">len_sent</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">requested_file</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

    <span class="c1"># Receive a response</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="n">decompressor</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2Decompressor</span><span class="p">()</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BLOCK_SIZE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;READ </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>

        <span class="c1"># Include any unconsumed data when feeding the</span>
        <span class="c1"># decompressor.</span>
        <span class="n">decompressed</span> <span class="o">=</span> <span class="n">decompressor</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">decompressed</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;DECOMPRESSED </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">decompressed</span><span class="p">)</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">decompressed</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;BUFFERING&#39;</span><span class="p">)</span>

    <span class="n">full_response</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
    <span class="n">lorem</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">requested_file</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;response matches file contents: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                 <span class="n">full_response</span> <span class="o">==</span> <span class="n">lorem</span><span class="p">)</span>

    <span class="c1"># Clean up</span>
    <span class="n">server</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
    <span class="n">server</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>It then opens a socket to communicate with the server as a client, and
requests the file (defaulting to <code class="docutils literal notranslate"><span class="pre">lorem.txt</span></code>) which contains:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">Lorem</span> <span class="n">ipsum</span> <span class="n">dolor</span> <span class="n">sit</span> <span class="n">amet</span><span class="p">,</span> <span class="n">consectetuer</span> <span class="n">adipiscing</span> <span class="n">elit</span><span class="o">.</span> <span class="n">Donec</span>
<span class="n">egestas</span><span class="p">,</span> <span class="n">enim</span> <span class="n">et</span> <span class="n">consectetuer</span> <span class="n">ullamcorper</span><span class="p">,</span> <span class="n">lectus</span> <span class="n">ligula</span> <span class="n">rutrum</span> <span class="n">leo</span><span class="p">,</span>
<span class="n">a</span> <span class="n">elementum</span> <span class="n">elit</span> <span class="n">tortor</span> <span class="n">eu</span> <span class="n">quam</span><span class="o">.</span> <span class="n">Duis</span> <span class="n">tincidunt</span> <span class="n">nisi</span> <span class="n">ut</span> <span class="n">ante</span><span class="o">.</span> <span class="n">Nulla</span>
<span class="n">facilisi</span><span class="o">.</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This implementation has obvious security implications.  Do not run
it on a server on the open Internet or in any environment where
security might be an issue.</p>
</div>
<p>Running <code class="docutils literal notranslate"><span class="pre">bz2_server.py</span></code> produces:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 bz2_server.py

Client: Contacting server on 127.0.0.1:57364
Client: sending filename: &quot;lorem.txt&quot;
Server: client asked for: &quot;lorem.txt&quot;
Server: RAW b&#39;Lorem ipsum dolor sit amet, cons&#39;
Server: BUFFERING
Server: RAW b&#39;ectetuer adipiscing elit. Donec\n&#39;
Server: BUFFERING
Server: RAW b&#39;egestas, enim et consectetuer ul&#39;
Server: BUFFERING
Server: RAW b&#39;lamcorper, lectus ligula rutrum &#39;
Server: BUFFERING
Server: RAW b&#39;leo,\na elementum elit tortor eu &#39;
Server: BUFFERING
Server: RAW b&#39;quam. Duis tincidunt nisi ut ant&#39;
Server: BUFFERING
Server: RAW b&#39;e. Nulla\nfacilisi.\n&#39;
Server: BUFFERING
Server: FLUSHING b&#39;425a6839314159265359ba83a48c000014d5800010400
504052fa7fe003000ba&#39;
Server: FLUSHING b&#39;9112793d4ca789068698a0d1a341901a0d53f4d1119a8
d4c9e812d755a67c107&#39;
Client: READ b&#39;425a6839314159265359ba83a48c000014d58000104005040
52fa7fe003000ba&#39;
Server: FLUSHING b&#39;98387682c7ca7b5a3bb75da77755eb81c1cb1ca94c4b6
faf209c52a90aaa4d16&#39;
Client: BUFFERING
Server: FLUSHING b&#39;a4a1b9c167a01c8d9ef32589d831e77df7a5753a398b1
1660e392126fc18a72a&#39;
Client: READ b&#39;9112793d4ca789068698a0d1a341901a0d53f4d1119a8d4c9
e812d755a67c107&#39;
Server: FLUSHING b&#39;1088716cc8dedda5d489da410748531278043d70a8a13
1c2b8adcd6a221bdb8c&#39;
Client: BUFFERING
Server: FLUSHING b&#39;7ff76b88c1d5342ee48a70a12175074918&#39;
Client: READ b&#39;98387682c7ca7b5a3bb75da77755eb81c1cb1ca94c4b6faf2
09c52a90aaa4d16&#39;
Client: BUFFERING
Client: READ b&#39;a4a1b9c167a01c8d9ef32589d831e77df7a5753a398b11660
e392126fc18a72a&#39;
Client: BUFFERING
Client: READ b&#39;1088716cc8dedda5d489da410748531278043d70a8a131c2b
8adcd6a221bdb8c&#39;
Client: BUFFERING
Client: READ b&#39;7ff76b88c1d5342ee48a70a12175074918&#39;
Client: DECOMPRESSED b&#39;Lorem ipsum dolor sit amet, consectetuer
adipiscing elit. Donec\negestas, enim et consectetuer ullamcorpe
r, lectus ligula rutrum leo,\na elementum elit tortor eu quam. D
uis tincidunt nisi ut ante. Nulla\nfacilisi.\n&#39;
Client: response matches file contents: True
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<ul class="last simple">
<li><a class="reference external" href="https://docs.python.org/3.7/library/bz2.html">Standard library documentation for bz2</a></li>
<li><a class="reference external" href="http://www.bzip.org/">bzip2.org</a> – The home page for
<code class="docutils literal notranslate"><span class="pre">bzip2</span></code>.</li>
<li><a class="reference internal" href="../zlib/index.html#module-zlib" title="zlib: GNU zlib compression library"><code class="xref py py-mod docutils literal notranslate"><span class="pre">zlib</span></code></a> – The <code class="docutils literal notranslate"><span class="pre">zlib</span></code> module for GNU zip compression.</li>
<li><a class="reference internal" href="../gzip/index.html#module-gzip" title="gzip: Read and write gzip files"><code class="xref py py-mod docutils literal notranslate"><span class="pre">gzip</span></code></a> – A file-like interface to GNU zip compressed
files.</li>
<li><a class="reference internal" href="../io/index.html#module-io" title="io: Implements file I/O and provides classes for working with buffers using file-like API."><code class="xref py py-mod docutils literal notranslate"><span class="pre">io</span></code></a> – Building-blocks for creating input and output
pipelines.</li>
<li><a class="reference internal" href="../porting_notes.html#porting-bz2"><span class="std std-ref">Python 2 to 3 porting notes for bz2</span></a></li>
</ul>
</div>
</div>
</div>



        <div id="footer-nav">
<a id="prev-link" href="../gzip/index.html"
   title="previous chapter"><i class="fa fa-arrow-circle-left"></i> gzip — Read and Write GNU zip Files</a>
<a id="next-link" href="../tarfile/index.html"
   title="next chapter">tarfile — Tar Archive Access <i class="fa fa-arrow-circle-right"></i></a>
        </div>

        </div>
      </div>

      <div class="pure-u-1-4">
        <div class="sidebar-wrapper">
          <div class="sidebar">
<div id="sidebar-toc">
  <h5>Quick Links</h5>
  <ul>
    
    <li><a href="#one-shot-operations-in-memory"><i class="fa fa-caret-right"></i>One-shot Operations in Memory</a></li>
    
    <li><a href="#incremental-compression-and-decompression"><i class="fa fa-caret-right"></i>Incremental Compression and Decompression</a></li>
    
    <li><a href="#mixed-content-streams"><i class="fa fa-caret-right"></i>Mixed Content Streams</a></li>
    
    <li><a href="#writing-compressed-files"><i class="fa fa-caret-right"></i>Writing Compressed Files</a></li>
    
    <li><a href="#reading-compressed-files"><i class="fa fa-caret-right"></i>Reading Compressed Files</a></li>
    
    <li><a href="#reading-and-writing-unicode-data"><i class="fa fa-caret-right"></i>Reading and Writing Unicode Data</a></li>
    
    <li><a href="#compressing-network-data"><i class="fa fa-caret-right"></i>Compressing Network Data</a></li>
    
  </ul>
</div>

          </div>
          <div class="sidebar"><div id="sidebar-last-updated">
  This page was last updated 2016-12-29.
</div>

          </div>
          <div class="sidebar">
<div id="sidebar-nav">
  <h5>Navigation</h5>
  <ul>
    <li><a href="../gzip/index.html"
           title="previous chapter"><i class="fa fa-arrow-circle-left"></i>gzip — Read and Write GNU zip Files</a></li>
    <li><a href="../tarfile/index.html"
           title="next chapter"><i class="fa fa-arrow-circle-right"></i>tarfile — Tar Archive Access</a></li>
  </ul>
</div>
          </div>
          <div class="sidebar"><div id="sidebar-book"><a target="new" href="https://doughellmann.com/blog/the-python-3-standard-library-by-example/"><img src="../_static/book-cover-image-med.jpg"><br>Get the book</a></div>
          </div>
          <div class="sidebar"><div id="sidebar-example-disclaimer">
<p>The output from all the example programs
from PyMOTW-3 has been generated with Python 3.7.9, unless
otherwise noted. Some of the features described here may not be
available in earlier versions of Python.</p>
<p>Looking for <a href="/2/">examples for Python 2</a>?</p>
</div>
          </div>

        </div>
      </div>

    </div>

    <div class="pure-g-r" id="footer">

      <div class="pure-u-1-3">
        <div class="footer-list">
            <h4>This Site</h4>
            <ul>
              <li><a href="../py-modindex.html"><i class="fa fa-list fa-lg"></i> Module Index</a></li>
              <li><a href="../genindex.html"><i class="fa fa-italic fa-lg"></i> Index</a></li>
            </ul>
        </div>
      </div><div class="pure-u-1-3">
          <div class="footer-content">
            <div class="socialmedia">
              <a class="sociallink" href="../index.html"
       title="Home">
      <i class="fa fa-home fa-lg"></i></a>
              <a class="sociallink" href="../about.html"
       title="About">
      <i class="fa fa-user fa-lg"></i></a>
              <a class="sociallink" href="http://www.twitter.com/pymotw"
       title="Twitter">
      <i class="fa fa-twitter fa-lg"></i></a>
              <a class="sociallink" href="http://feeds.doughellmann.com/PyMOTW"
       title="Subscribe via RSS">
      <i class="fa fa-rss-square fa-lg"></i></a>
              <a class="sociallink" href="http://feedburner.google.com/fb/a/mailverify?uri=PyMOTW&amp;loc=en_US"
       title="Subscribe via Email">
      <i class="fa fa-envelope fa-lg"></i></a>
            </div>

            <div class="copyright">
              <a rel="author" href="../about.html">&copy; Copyright 2021, Doug Hellmann</a>
            </div>

            <div class="cc"><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/deed.en_US" rel="license"><img alt="Creative Commons License BY-NC-SA" style="border-width:0; align: center;" width="88" height="31" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFgAAAAfCAMAAABUFvrSAAAABGdBTUEAALGOfPtRkwAAAf5QTFRF////////////AAAADQwNDQ4NDg4OEBAQGRkZGxsbHxscICAgIx8gJCQkKCUmKCgoKCkoKSkpKSopKicnKioqLS0tMDAwMS0uMjExMjMxNTY1Pj8+Pzc5Pzs8QEBAQ0RDUFBQUFFQWldYXV5dYGBgY19haGVmbmxscHBwcHJvdXJzdnN0eHV2eXx5en15fH98fX98fnt8f4F+gICAgoWChIGChIWEhIaEh4aHiYyJjIqLjoeLj4+PkY+PkZORkZSRk5iTlZmUlpmWmJaXmpiZnp2dnqCdn5aan5+fn6Oeoqaho6Gho6ijpqqmq7GqrKurrLKrrbOsrrOtrrStr6+vr7Kvr7Sur7WusLOvsLWvsLavsbewsrexsrixs7iytLmztLqztbW1tbq0tru1t7y2uL23ub64ub65urm5ur+5ur+6u8C6u8C7vMC8vMG7vMG8vcK8vcK9vsK9vsO+v7+/v8O+v8S+wMS/wMW/wMXAwcXAwsfCw8fCw8jDxMfDxMjDxMnExcnExcnFxsrFxsrGx8vHyMfHyMzHyMzIycjIyc3Iyc3Jys3Jy8rLy87Ky8/Ky8/LzM/LzNDLzNDMzdDMzdHMzdHNztHNztLOz8/Pz9PP0NPP0NTQ0dTQ0dTR0tXR0tXS09bS1tXV39/f4N/g4+Pj6Ofn7+/v8fHx////rrSdFQAAAAN0Uk5TAAoO5yEBUwAAA+FJREFUSMe1lo9301QUx6uXUmaf0qJ26iTrRoVinUzjQNR1gAyH6Lqx6XTDoVvXbU7qhA5m7CgYWaTDlLa6AiFsba3t+y+9Sdr8OvVMi7zTnLTf5H7ee9/73n11PA1PpDkcADPRWPwKt8YLG2I2n89m7gh8iluJz0dnpqe+HBsdHRn+7w3JyF1cvpbk05mCJG8Xi9uPpMLdNJ9cXV5UyBNjoyMtkR2A3B9Tt8SCfLTTqUzC2XlMvpcRbnA/IPmryYnzoyM9XuWBt8eI21FBcAy5Qk4KtxkGtQ1I+fRNbnk+evHC5NhJDwATDDIAnhNa1ImdFQTHr6WEvNyFPFeATSTYgAu/dl3/I31jNR6bnZ76eDf4yxRb2Q+71aiz/0JB8JXkrZzCdbFVqrUhRHuu54XkytLczAUvBFADUB6ARwnyqEp/t02prK9XdAXBHC9KyPWVqd6qPhyzlOG55dhsL/hLDTD1A3rYAy+dRu6eXaGKruA75wi2hbqigNd+LYSRW6XUSh64l05dXYruA1OPZfAOD3vhObL/ILDvQkRXynSdvPpaiJB+TVHAfEZuA9d9amlVF7TJd3nu+xgwyu8AqNOnDGAM8/obOLhQpWQotPYReZ/SQdKuKQpY2DwKwFJbGwI4VhCSlxchSFUnNC+CCgaV9RAKoZKh1J4le9FmQv5SFQW88aATXGhEws8wrHb7AANc0CndQS+ag5ERaieke0FXvnkxoYL/1MGi7FSmmVBXMDOu3gLK5J2PMjdXv2tmBX6pDdKSkq39DWXh3G1KI4QYVmS3AHCIPnCXE+4hHy6PcfeQ6sV2lufiL2jJ0wasp4p2k/Z2CEXeeqahDBLS1/c8+dBIXq4IkFAiWQ1QtxtnUMz/wsXfBj+1LzdUKn17dvXXzEqfMoFDNWO57QCe22dskKB5g7zXbVN+i0RKumKxonrfzaIVys2wYu7TVrd0PXn1rOnJC4JTFjF5c19/gnXLFwj6jJJz1rOjoi63LnBRfbmNM+qNunG5baSufhu9OPX5my2VTWEzrHrRbIP8dHl+dnpyrIVDBME/q1u6/E9bGmt9i2AsQmeaFaFwIb22soSlfuL8SEtgOCJKB5BsKkNltWyK7zzWMY3X4exDc6GvsljoX5FzR+BxwdCbf3jAdjTJv5/S39H2B2iXpmgXpWB7iVrB0JuVzpgP07CUO2WKqX+oiVL/benKImhgOIzHf7hx/A/IBdHsQ6Nsmruilo4afVFqB8PLn2U2H8hbxeKWjH9YvuiwxNiMaNhALZptCg5d7zh+Sczmclnx0vEOax6ajdjucSMPTcD/97/Cp54Q929ZZbgcR3o0hAAAAABJRU5ErkJggg=="/></a>
            </div>

          </div></div><div class="pure-u-1-3">
          <div class="footer-list">
            <h4>Other Writing</h4>
            <ul>
              <li><a href="https://doughellmann.com/"><i class="fa fa-pencil fa-lg"></i> Blog</a></li>
              <li><a href="https://doughellmann.com/blog/the-python-standard-library-by-example/"><i class="fa fa-book fa-lg"></i> The Python Standard Library By Example</a></li>
            </ul>
          </div>
        </div><script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-38546875-3', 'pymotw.com');
  ga('send', 'pageview');
</script>

  </body>
</html>