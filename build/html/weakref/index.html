<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>weakref — Impermanent References to Objects &mdash; PyMOTW 3</title>

    <link rel="stylesheet" href="../_static/pure-min.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/font-awesome/css/font-awesome.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pymotw.css" type="text/css">

    <link rel="shortcut icon" type="image/png" href="../_static/favicon.png">

    <link rel="alternate" type="application/atom+xml"
          title="Doug Hellmann"
          href="http://feeds.doughellmann.com/DougHellmann" />
    <link rel="alternate" type="application/atom+xml"
          title="PyMOTW Updates"
          href="http://feeds.doughellmann.com/PyMOTW" />

    <meta name="verify-v1" content="5saTcOa2HLac4V85yUg3SARfun1PqT5Upu7IR/6fpv4="/>

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@pymotw" />
    <meta name="twitter:title" content="weakref — Impermanent References to Objects" />
    <meta name="twitter:image" content="https://pymotw.com/3/_static/logo-large.png" />

  </head>
  <body>

    <div class="pure-menu pure-menu-open pure-menu-horizontal" id="site-menu">
      <a class="pure-menu-heading" href="../index.html"><img src="../_static/logo.png"> PyMOTW-3</a>

      <ul id="top-menu">
        <li class="pure-menu-selected"><a href="../py-modindex.html"><i class="fa fa-list fa-lg"></i> Module Index</a></li>
        <li class="pure-menu-selected"><a href="../genindex.html"><i class="fa fa-italic fa-lg"></i> Index</a></li>
        <li class="pure-menu-selected"><a class="sociallink" href="http://www.twitter.com/pymotw"
       title="Twitter">
      <i class="fa fa-twitter fa-lg"></i></a></a>
        <li class="pure-menu-selected"><a class="sociallink" href="http://feeds.doughellmann.com/PyMOTW"
       title="Subscribe via RSS">
      <i class="fa fa-rss-square fa-lg"></i></a></li>
      </ul>

    </div>

    <div class="pure-menu pure-menu-open pure-menu-vertical" id="breadcrumbs-menu">
      
      <ul id="breadcrumbs">
        <li class="pure-menu-selected"><a href="../data_structures.html"><i class="fa fa-arrow-circle-up"></i> Data Structures</a></li>
      </ul>
    </div>

    <div class="pure-g-r" id="content-container">

      <div class="pure-u-3-4">
        <div class="content">
          
  <div class="section" id="module-weakref">
<span id="weakref-impermanent-references-to-objects"></span><h1>weakref — Impermanent References to Objects<a class="headerlink" href="#module-weakref" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Purpose:</th><td class="field-body">Refer to an “expensive” object, but allow its memory to be
reclaimed by the garbage collector if there are no other
non-weak references.</td>
</tr>
</tbody>
</table>
<p>The <code class="docutils literal notranslate"><span class="pre">weakref</span></code> module supports weak references to objects. A normal
reference increments the reference count on the object and prevents it
from being garbage collected. This outcome is not always desirable,
especially when a circular reference might be present or when a cache
of objects should be deleted when memory is needed.  A weak reference
is a handle to an object that does not keep it from being cleaned up
automatically.</p>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<p>Weak references to objects are managed through the <code class="docutils literal notranslate"><span class="pre">ref</span></code>
class. To retrieve the original object, call the reference object.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">weakref_ref.py</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">weakref</span>


<span class="k">class</span> <span class="nc">ExpensiveObject</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(Deleting </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>


<span class="n">obj</span> <span class="o">=</span> <span class="n">ExpensiveObject</span><span class="p">()</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;obj:&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ref:&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;r():&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;deleting obj&#39;</span><span class="p">)</span>
<span class="k">del</span> <span class="n">obj</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;r():&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">())</span>
</pre></div>
</div>
</div>
<p>In this case, since <code class="docutils literal notranslate"><span class="pre">obj</span></code> is deleted before the second call to the
reference, the <code class="docutils literal notranslate"><span class="pre">ref</span></code> returns <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 weakref_ref.py

obj: &lt;__main__.ExpensiveObject object at 0x1007b1a58&gt;
ref: &lt;weakref at 0x1007a92c8; to &#39;ExpensiveObject&#39; at
0x1007b1a58&gt;
r(): &lt;__main__.ExpensiveObject object at 0x1007b1a58&gt;
deleting obj
(Deleting &lt;__main__.ExpensiveObject object at 0x1007b1a58&gt;)
r(): None
</pre></div>
</div>
</div>
<div class="section" id="reference-callbacks">
<h2>Reference Callbacks<a class="headerlink" href="#reference-callbacks" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">ref</span></code> constructor accepts an optional callback function that is
invoked when the referenced object is deleted.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">weakref_ref_callback.py</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">weakref</span>


<span class="k">class</span> <span class="nc">ExpensiveObject</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(Deleting </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">reference</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Invoked when referenced object is deleted&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;callback(</span><span class="si">{!r}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reference</span><span class="p">))</span>


<span class="n">obj</span> <span class="o">=</span> <span class="n">ExpensiveObject</span><span class="p">()</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;obj:&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ref:&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;r():&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;deleting obj&#39;</span><span class="p">)</span>
<span class="k">del</span> <span class="n">obj</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;r():&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">())</span>
</pre></div>
</div>
</div>
<p>The callback receives the reference object as an argument after the
reference is “dead” and no longer refers to the original object. One
use for this feature is to remove the weak reference object from a
cache.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 weakref_ref_callback.py

obj: &lt;__main__.ExpensiveObject object at 0x1010b1978&gt;
ref: &lt;weakref at 0x1010a92c8; to &#39;ExpensiveObject&#39; at
0x1010b1978&gt;
r(): &lt;__main__.ExpensiveObject object at 0x1010b1978&gt;
deleting obj
(Deleting &lt;__main__.ExpensiveObject object at 0x1010b1978&gt;)
callback(&lt;weakref at 0x1010a92c8; dead&gt;)
r(): None
</pre></div>
</div>
</div>
<div class="section" id="finalizing-objects">
<h2>Finalizing Objects<a class="headerlink" href="#finalizing-objects" title="Permalink to this headline">¶</a></h2>
<p>For more robust management of resources when weak references are
cleaned up, use <code class="docutils literal notranslate"><span class="pre">finalize</span></code> to associate callbacks with
objects. A <code class="docutils literal notranslate"><span class="pre">finalize</span></code> instance is retained until the attached
object is deleted, even if the application does not retain a reference
to the finalizer.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">weakref_finalize.py</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">weakref</span>


<span class="k">class</span> <span class="nc">ExpensiveObject</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(Deleting </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">on_finalize</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;on_finalize(</span><span class="si">{!r}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>


<span class="n">obj</span> <span class="o">=</span> <span class="n">ExpensiveObject</span><span class="p">()</span>
<span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">on_finalize</span><span class="p">,</span> <span class="s1">&#39;extra argument&#39;</span><span class="p">)</span>

<span class="k">del</span> <span class="n">obj</span>
</pre></div>
</div>
</div>
<p>The arguments to <code class="docutils literal notranslate"><span class="pre">finalize</span></code> are the object to track, a callable
to invoke when the object is garbage collected, and any positional or
named arguments to pass to the callable.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 weakref_finalize.py

(Deleting &lt;__main__.ExpensiveObject object at 0x1019b10f0&gt;)
on_finalize((&#39;extra argument&#39;,))
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">finalize</span></code> instance has a writable propertly <code class="docutils literal notranslate"><span class="pre">atexit</span></code> to
control whether the callback is invoked as a program is exiting,
if it hasn’t already been called.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">weakref_finalize_atexit.py</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">weakref</span>


<span class="k">class</span> <span class="nc">ExpensiveObject</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(Deleting </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">on_finalize</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;on_finalize(</span><span class="si">{!r}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>


<span class="n">obj</span> <span class="o">=</span> <span class="n">ExpensiveObject</span><span class="p">()</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">on_finalize</span><span class="p">,</span> <span class="s1">&#39;extra argument&#39;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">atexit</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<p>The default is to invoke the callback. Setting <code class="docutils literal notranslate"><span class="pre">atexit</span></code> to false
disables that behavior.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 weakref_finalize_atexit.py 1

on_finalize((&#39;extra argument&#39;,))
(Deleting &lt;__main__.ExpensiveObject object at 0x1007b10f0&gt;)

$ python3 weakref_finalize_atexit.py 0
</pre></div>
</div>
<p>Giving the <code class="docutils literal notranslate"><span class="pre">finalize</span></code> instance a reference to the object it tracks
causes a reference to be retained, so the object is never garbage
collected.</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">weakref_finalize_reference.py</span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">weakref</span>


<span class="k">class</span> <span class="nc">ExpensiveObject</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(Deleting </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">on_finalize</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;on_finalize(</span><span class="si">{!r}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>


<span class="n">obj</span> <span class="o">=</span> <span class="n">ExpensiveObject</span><span class="p">()</span>
<span class="n">obj_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">on_finalize</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">atexit</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">del</span> <span class="n">obj</span>

<span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_objects</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">==</span> <span class="n">obj_id</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;found uncollected object in gc&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>As this example shows, even though the explicit reference to <code class="docutils literal notranslate"><span class="pre">obj</span></code>
is deleted, the object is retained and visible to the garbage
collector through <code class="docutils literal notranslate"><span class="pre">f</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 weakref_finalize_reference.py

found uncollected object in gc
</pre></div>
</div>
<p>Using a bound method of a tracked object as the callable can also
prevent an object from being finalized properly.</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">weakref_finalize_reference_method.py</span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">weakref</span>


<span class="k">class</span> <span class="nc">ExpensiveObject</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(Deleting </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">do_finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;do_finalize&#39;</span><span class="p">)</span>


<span class="n">obj</span> <span class="o">=</span> <span class="n">ExpensiveObject</span><span class="p">()</span>
<span class="n">obj_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">do_finalize</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">atexit</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">del</span> <span class="n">obj</span>

<span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_objects</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">==</span> <span class="n">obj_id</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;found uncollected object in gc&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Because the callable given to <code class="docutils literal notranslate"><span class="pre">finalize</span></code> is a bound method of
the instance <code class="docutils literal notranslate"><span class="pre">obj</span></code>, the finalize object holds a reference to
<code class="docutils literal notranslate"><span class="pre">obj</span></code>, which cannot be deleted and garbage collected.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 weakref_finalize_reference_method.py

found uncollected object in gc
</pre></div>
</div>
</div>
<div class="section" id="proxies">
<h2>Proxies<a class="headerlink" href="#proxies" title="Permalink to this headline">¶</a></h2>
<p>It is sometimes more convenient to use a proxy, rather than a weak
reference.  Proxies can be used as though they were the original
object, and do not need to be called before the object is accessible.
As a consequence, they can be passed to a library that does not know it is
receiving a reference instead of the real object.</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">weakref_proxy.py</span><a class="headerlink" href="#id7" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">weakref</span>


<span class="k">class</span> <span class="nc">ExpensiveObject</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(Deleting </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>


<span class="n">obj</span> <span class="o">=</span> <span class="n">ExpensiveObject</span><span class="p">(</span><span class="s1">&#39;My Object&#39;</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;via obj:&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;via ref:&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;via proxy:&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">del</span> <span class="n">obj</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;via proxy:&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>If the proxy is accessed after the referent object is removed, a
<code class="docutils literal notranslate"><span class="pre">ReferenceError</span></code> exception is raised.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 weakref_proxy.py

via obj: My Object
via ref: My Object
via proxy: My Object
(Deleting &lt;__main__.ExpensiveObject object at 0x1007aa7b8&gt;)
Traceback (most recent call last):
  File &quot;weakref_proxy.py&quot;, line 30, in &lt;module&gt;
    print(&#39;via proxy:&#39;, p.name)
ReferenceError: weakly-referenced object no longer exists
</pre></div>
</div>
</div>
<div class="section" id="caching-objects">
<h2>Caching Objects<a class="headerlink" href="#caching-objects" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">ref</span></code> and <code class="docutils literal notranslate"><span class="pre">proxy</span></code> classes are considered “low
level.” While they are useful for maintaining weak references to
individual objects and allowing cycles to be garbage collected, the
<code class="docutils literal notranslate"><span class="pre">WeakKeyDictionary</span></code> and <code class="docutils literal notranslate"><span class="pre">WeakValueDictionary</span></code> classes provide a
more appropriate API for creating a cache of several objects.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">WeakValueDictionary</span></code> class uses weak references to the values it
holds, allowing them to be garbage collected when other code is not
actually using them.  Using explicit calls to the garbage collector
illustrates the difference between memory handling with a regular
dictionary and <code class="docutils literal notranslate"><span class="pre">WeakValueDictionary</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">weakref_valuedict.py</span><a class="headerlink" href="#id8" title="Permalink to this code">¶</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="k">import</span> <span class="n">pprint</span>
<span class="kn">import</span> <span class="nn">weakref</span>

<span class="n">gc</span><span class="o">.</span><span class="n">set_debug</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">DEBUG_UNCOLLECTABLE</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ExpensiveObject</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;ExpensiveObject(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    (Deleting </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">demo</span><span class="p">(</span><span class="n">cache_factory</span><span class="p">):</span>
    <span class="c1"># hold objects so any weak references</span>
    <span class="c1"># are not removed immediately</span>
    <span class="n">all_refs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># create the cache using the factory</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CACHE TYPE:&#39;</span><span class="p">,</span> <span class="n">cache_factory</span><span class="p">)</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">cache_factory</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">]:</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">ExpensiveObject</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span>
        <span class="n">all_refs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span>
        <span class="k">del</span> <span class="n">o</span>  <span class="c1"># decref</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  all_refs =&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">pprint</span><span class="p">(</span><span class="n">all_refs</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Before, cache contains:&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    </span><span class="si">{}</span><span class="s1"> = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">del</span> <span class="n">value</span>  <span class="c1"># decref</span>

    <span class="c1"># remove all references to the objects except the cache</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Cleanup:&#39;</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">all_refs</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  After, cache contains:&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    </span><span class="si">{}</span><span class="s1"> = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  demo returning&#39;</span><span class="p">)</span>
    <span class="k">return</span>


<span class="n">demo</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="n">demo</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Any loop variables that refer to the values being cached must be
cleared explicitly so the reference count of the object is
decremented. Otherwise, the garbage collector will not remove the
objects and they will remain in the cache. Similarly, the <code class="docutils literal notranslate"><span class="pre">all_refs</span></code>
variable is used to hold references to prevent them from being garbage
collected prematurely.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 weakref_valuedict.py

CACHE TYPE: &lt;class &#39;dict&#39;&gt;
  all_refs = {&#39;one&#39;: ExpensiveObject(one),
 &#39;three&#39;: ExpensiveObject(three),
 &#39;two&#39;: ExpensiveObject(two)}

  Before, cache contains: [&#39;one&#39;, &#39;three&#39;, &#39;two&#39;]
    one = ExpensiveObject(one)
    three = ExpensiveObject(three)
    two = ExpensiveObject(two)

  Cleanup:

  After, cache contains: [&#39;one&#39;, &#39;three&#39;, &#39;two&#39;]
    one = ExpensiveObject(one)
    three = ExpensiveObject(three)
    two = ExpensiveObject(two)
  demo returning
    (Deleting ExpensiveObject(one))
    (Deleting ExpensiveObject(three))
    (Deleting ExpensiveObject(two))

CACHE TYPE: &lt;class &#39;weakref.WeakValueDictionary&#39;&gt;
  all_refs = {&#39;one&#39;: ExpensiveObject(one),
 &#39;three&#39;: ExpensiveObject(three),
 &#39;two&#39;: ExpensiveObject(two)}

  Before, cache contains: [&#39;one&#39;, &#39;three&#39;, &#39;two&#39;]
    one = ExpensiveObject(one)
    three = ExpensiveObject(three)
    two = ExpensiveObject(two)

  Cleanup:
    (Deleting ExpensiveObject(one))
    (Deleting ExpensiveObject(three))
    (Deleting ExpensiveObject(two))

  After, cache contains: []
  demo returning
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">WeakKeyDictionary</span></code> works similarly but uses weak
references for the keys instead of the values in the dictionary.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>The library documentation for <code class="docutils literal notranslate"><span class="pre">weakref</span></code> contains this
warning:</p>
<blockquote class="last">
<div>Caution: Because a <code class="docutils literal notranslate"><span class="pre">WeakValueDictionary</span></code> is built on top of a
Python dictionary, it must not change size when iterating over
it. This can be difficult to ensure for a
<code class="docutils literal notranslate"><span class="pre">WeakValueDictionary</span></code> because actions performed by the program
during iteration may cause items in the dictionary to vanish “by
magic” (as a side effect of garbage collection).</div></blockquote>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<ul class="last simple">
<li><a class="reference external" href="https://docs.python.org/3.7/library/weakref.html">Standard library documentation for weakref</a></li>
<li><a class="reference internal" href="../gc/index.html#module-gc" title="gc: Garbage Collector"><code class="xref py py-mod docutils literal notranslate"><span class="pre">gc</span></code></a> – The <code class="docutils literal notranslate"><span class="pre">gc</span></code> module is the interface to the
interpreter’s garbage collector.</li>
<li><span class="target" id="index-0"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0205"><strong>PEP 205</strong></a> – “Weak References” enhancement proposal.</li>
</ul>
</div>
</div>
</div>



        <div id="footer-nav">
<a id="prev-link" href="../struct/index.html"
   title="previous chapter"><i class="fa fa-arrow-circle-left"></i> struct — Binary Data Structures</a>
<a id="next-link" href="../copy/index.html"
   title="next chapter">copy — Duplicate Objects <i class="fa fa-arrow-circle-right"></i></a>
        </div>

        </div>
      </div>

      <div class="pure-u-1-4">
        <div class="sidebar-wrapper">
          <div class="sidebar">
<div id="sidebar-toc">
  <h5>Quick Links</h5>
  <ul>
    
    <li><a href="#references"><i class="fa fa-caret-right"></i>References</a></li>
    
    <li><a href="#reference-callbacks"><i class="fa fa-caret-right"></i>Reference Callbacks</a></li>
    
    <li><a href="#finalizing-objects"><i class="fa fa-caret-right"></i>Finalizing Objects</a></li>
    
    <li><a href="#proxies"><i class="fa fa-caret-right"></i>Proxies</a></li>
    
    <li><a href="#caching-objects"><i class="fa fa-caret-right"></i>Caching Objects</a></li>
    
  </ul>
</div>

          </div>
          <div class="sidebar"><div id="sidebar-last-updated">
  This page was last updated 2017-01-28.
</div>

          </div>
          <div class="sidebar">
<div id="sidebar-nav">
  <h5>Navigation</h5>
  <ul>
    <li><a href="../struct/index.html"
           title="previous chapter"><i class="fa fa-arrow-circle-left"></i>struct — Binary Data Structures</a></li>
    <li><a href="../copy/index.html"
           title="next chapter"><i class="fa fa-arrow-circle-right"></i>copy — Duplicate Objects</a></li>
  </ul>
</div>
          </div>
          <div class="sidebar"><div id="sidebar-book"><a target="new" href="https://doughellmann.com/blog/the-python-3-standard-library-by-example/"><img src="../_static/book-cover-image-med.jpg"><br>Get the book</a></div>
          </div>
          <div class="sidebar"><div id="sidebar-example-disclaimer">
<p>The output from all the example programs
from PyMOTW-3 has been generated with Python 3.7.9, unless
otherwise noted. Some of the features described here may not be
available in earlier versions of Python.</p>
<p>Looking for <a href="/2/">examples for Python 2</a>?</p>
</div>
          </div>

        </div>
      </div>

    </div>

    <div class="pure-g-r" id="footer">

      <div class="pure-u-1-3">
        <div class="footer-list">
            <h4>This Site</h4>
            <ul>
              <li><a href="../py-modindex.html"><i class="fa fa-list fa-lg"></i> Module Index</a></li>
              <li><a href="../genindex.html"><i class="fa fa-italic fa-lg"></i> Index</a></li>
            </ul>
        </div>
      </div><div class="pure-u-1-3">
          <div class="footer-content">
            <div class="socialmedia">
              <a class="sociallink" href="../index.html"
       title="Home">
      <i class="fa fa-home fa-lg"></i></a>
              <a class="sociallink" href="../about.html"
       title="About">
      <i class="fa fa-user fa-lg"></i></a>
              <a class="sociallink" href="http://www.twitter.com/pymotw"
       title="Twitter">
      <i class="fa fa-twitter fa-lg"></i></a>
              <a class="sociallink" href="http://feeds.doughellmann.com/PyMOTW"
       title="Subscribe via RSS">
      <i class="fa fa-rss-square fa-lg"></i></a>
              <a class="sociallink" href="http://feedburner.google.com/fb/a/mailverify?uri=PyMOTW&amp;loc=en_US"
       title="Subscribe via Email">
      <i class="fa fa-envelope fa-lg"></i></a>
            </div>

            <div class="copyright">
              <a rel="author" href="../about.html">&copy; Copyright 2021, Doug Hellmann</a>
            </div>

            <div class="cc"><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/deed.en_US" rel="license"><img alt="Creative Commons License BY-NC-SA" style="border-width:0; align: center;" width="88" height="31" src="data:image/png;base64,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"/></a>
            </div>

          </div></div><div class="pure-u-1-3">
          <div class="footer-list">
            <h4>Other Writing</h4>
            <ul>
              <li><a href="https://doughellmann.com/"><i class="fa fa-pencil fa-lg"></i> Blog</a></li>
              <li><a href="https://doughellmann.com/blog/the-python-standard-library-by-example/"><i class="fa fa-book fa-lg"></i> The Python Standard Library By Example</a></li>
            </ul>
          </div>
        </div><script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-38546875-3', 'pymotw.com');
  ga('send', 'pageview');
</script>

  </body>
</html>